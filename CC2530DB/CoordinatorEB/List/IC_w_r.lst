###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.10.1.40194/W32 for 8051         03/Mar/2020  13:32:26 #
# Copyright 2004-2011 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  C:\Texas Instruments\ZStack-CC2530-2.5.1a\Projects #
#                          \zstack\Samples\Diplomaproject\Source\IC_w_r.c     #
#    Command line       =  -f "C:\Texas Instruments\ZStack-CC2530-2.5.1a\Proj #
#                          ects\zstack\Samples\Diplomaproject\CC2530DB\..\..\ #
#                          ..\Tools\CC2530DB\f8wCoord.cfg" (-DCPU32MHZ        #
#                          -DROOT=__near_func -DMAC_CFG_APP_PENDING_QUEUE=TRU #
#                          E -DMAC_CFG_TX_DATA_MAX=5 -DMAC_CFG_TX_MAX=8       #
#                          -DMAC_CFG_RX_MAX=5 -DZDO_COORDINATOR -DRTR_NWK)    #
#                          -f "C:\Texas Instruments\ZStack-CC2530-2.5.1a\Proj #
#                          ects\zstack\Samples\Diplomaproject\CC2530DB\..\..\ #
#                          ..\Tools\CC2530DB\f8wConfig.cfg" (-DZIGBEEPRO      #
#                          -DSECURE=0 -DZG_SECURE_DYNAMIC=0 -DREFLECTOR       #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFFF                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DLINK_STATUS_JITTER_MASK=0x007F                   #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116                           #
#                          -DZDNWKMGR_MIN_TRANSMISSIONS=20 "-DCONST=const     #
#                          __code" -DGENERIC=__generic                        #
#                          -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000        #
#                          -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100)   #
#                          -DREJOIN_POLL_RATE=440 "C:\Texas                   #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\Source\IC_w_r.c" -D          #
#                          ZTOOL_P1 -D xMT_TASK -D xMT_SYS_FUNC -D            #
#                          xMT_ZDO_FUNC -D xLCD_SUPPORTED=DEBUG -lC           #
#                          "C:\Texas Instruments\ZStack-CC2530-2.5.1a\Project #
#                          s\zstack\Samples\Diplomaproject\CC2530DB\Coordinat #
#                          orEB\List\" -lA "C:\Texas                          #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\CoordinatorEB\List\ #
#                          " --diag_suppress Pe001,Pa010 -o "C:\Texas         #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\CoordinatorEB\Obj\" #
#                           -e --no_cse --no_unroll --no_inline               #
#                          --no_code_motion --no_tbaa --debug --core=plain    #
#                          --dptr=16,1 --data_model=large                     #
#                          --code_model=banked --calling_convention=xdata_ree #
#                          ntrant --place_constants=data_rom                  #
#                          --nr_virtual_regs 16 -I "C:\Texas                  #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\" -I "C:\Texas      #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\..\Source\" -I      #
#                          "C:\Texas Instruments\ZStack-CC2530-2.5.1a\Project #
#                          s\zstack\Samples\Diplomaproject\CC2530DB\..\..\..\ #
#                          ZMain\TI2530DB\" -I "C:\Texas                      #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\..\..\..\..\..\Comp #
#                          onents\hal\include\" -I "C:\Texas                  #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\..\..\..\..\..\Comp #
#                          onents\hal\target\CC2530EB\" -I "C:\Texas          #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\..\..\..\..\..\Comp #
#                          onents\mac\include\" -I "C:\Texas                  #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\..\..\..\..\..\Comp #
#                          onents\mac\high_level\" -I "C:\Texas               #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\..\..\..\..\..\Comp #
#                          onents\mac\low_level\srf04\" -I "C:\Texas          #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\..\..\..\..\..\Comp #
#                          onents\mac\low_level\srf04\single_chip\" -I        #
#                          "C:\Texas Instruments\ZStack-CC2530-2.5.1a\Project #
#                          s\zstack\Samples\Diplomaproject\CC2530DB\..\..\..\ #
#                          ..\..\Components\mt\" -I "C:\Texas                 #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\..\..\..\..\..\Comp #
#                          onents\osal\include\" -I "C:\Texas                 #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\..\..\..\..\..\Comp #
#                          onents\services\saddr\" -I "C:\Texas               #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\..\..\..\..\..\Comp #
#                          onents\services\sdata\" -I "C:\Texas               #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\..\..\..\..\..\Comp #
#                          onents\stack\af\" -I "C:\Texas                     #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\..\..\..\..\..\Comp #
#                          onents\stack\nwk\" -I "C:\Texas                    #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\..\..\..\..\..\Comp #
#                          onents\stack\sapi\" -I "C:\Texas                   #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\..\..\..\..\..\Comp #
#                          onents\stack\sec\" -I "C:\Texas                    #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\..\..\..\..\..\Comp #
#                          onents\stack\sys\" -I "C:\Texas                    #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\..\..\..\..\..\Comp #
#                          onents\stack\zdo\" -I "C:\Texas                    #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\..\..\..\..\..\Comp #
#                          onents\zmac\" -I "C:\Texas                         #
#                          Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\S #
#                          amples\Diplomaproject\CC2530DB\..\..\..\..\..\Comp #
#                          onents\zmac\f8w\" -On                              #
#    List file          =  C:\Texas Instruments\ZStack-CC2530-2.5.1a\Projects #
#                          \zstack\Samples\Diplomaproject\CC2530DB\Coordinato #
#                          rEB\List\IC_w_r.lst                                #
#    Object file        =  C:\Texas Instruments\ZStack-CC2530-2.5.1a\Projects #
#                          \zstack\Samples\Diplomaproject\CC2530DB\Coordinato #
#                          rEB\Obj\IC_w_r.r51                                 #
#                                                                             #
#                                                                             #
###############################################################################

C:\Texas Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\Samples\Diplomaproject\Source\IC_w_r.c
      1          #include"variable.h"

   \                                 In  segment SFR_AN, at 0x80
   \   union <unnamed> volatile __sfr _A_P0
   \                     _A_P0:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0x90
   \   union <unnamed> volatile __sfr _A_P1
   \                     _A_P1:
   \   000000                DS 1
      2          #include"rc522.h"
      3          #include"uart.h"
      4          
      5          
      6          void Delay_I_1us(unsigned int k);
      7          void SPIWriteByte(uchar infor);
      8          unsigned char SPIReadByte(void);
      9          unsigned char ReadRawRC(unsigned char Address);
     10          void WriteRawRC(unsigned char Address, unsigned char value);
     11          void SetBitMask(unsigned char reg,unsigned char mask) ;
     12          void ClearBitMask(unsigned char reg,unsigned char mask)  ;
     13          void PcdAntennaOn(void);
     14          void PcdAntennaOff(void);
     15          void PcdReset(void);
     16          void IC_CMT(uchar *UID,uchar *KEY,uchar RW,char *Dat);
     17          void M500PcdConfigISOType(unsigned char type);
     18          char PcdComMF522(unsigned char Command, 		//RC522命令字
     19                           unsigned char *pInData, 		//通过RC522发送到卡片的数据
     20                           unsigned char InLenByte,		//发送数据的字节长度
     21                           unsigned char *pOutData, 		//接收到的卡片返回数据
     22                           unsigned int  *pOutLenBit)	;
     23          char PcdRequest(unsigned char req_code,unsigned char *pTagType);
     24          char PcdAnticoll(unsigned char *pSnr);
     25          void CalulateCRC(unsigned char *pIndata,unsigned char len,unsigned char *pOutData);
     26          char PcdRead(unsigned char addr,unsigned char *pData);
     27          char PcdSelect(unsigned char *pSnr);
     28          char PcdHalt(void);
     29          char PcdHalt(void);
     30          char PcdWrite(unsigned char addr,unsigned char *pData);
     31          char PcdAuthState(unsigned char auth_mode,unsigned char addr,unsigned char *pKey,unsigned char *pSnr);
     32          
     33          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     34          void Delay_I_1us(unsigned int k)
   \                     Delay_I_1us:
     35          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
     36            uint i,j;
     37            for(i=0;i<k;i++)
   \   000000   7C00         MOV     R4,#0x0
   \   000002   7D00         MOV     R5,#0x0
   \                     ??Delay_I_1us_0:
   \   000004   C3           CLR     C
   \   000005   EC           MOV     A,R4
   \   000006   9A           SUBB    A,R2
   \   000007   ED           MOV     A,R5
   \   000008   9B           SUBB    A,R3
   \   000009   5021         JNC     ??Delay_I_1us_1
     38              for(j=0;j<32;j++);
   \   00000B   7800         MOV     R0,#0x0
   \   00000D   7900         MOV     R1,#0x0
   \                     ??Delay_I_1us_2:
   \   00000F   C3           CLR     C
   \   000010   E8           MOV     A,R0
   \   000011   9420         SUBB    A,#0x20
   \   000013   E9           MOV     A,R1
   \   000014   9400         SUBB    A,#0x0
   \   000016   500A         JNC     ??Delay_I_1us_3
   \   000018   E8           MOV     A,R0
   \   000019   2401         ADD     A,#0x1
   \   00001B   F8           MOV     R0,A
   \   00001C   E9           MOV     A,R1
   \   00001D   3400         ADDC    A,#0x0
   \   00001F   F9           MOV     R1,A
   \   000020   80ED         SJMP    ??Delay_I_1us_2
   \                     ??Delay_I_1us_3:
   \   000022   EC           MOV     A,R4
   \   000023   2401         ADD     A,#0x1
   \   000025   FC           MOV     R4,A
   \   000026   ED           MOV     A,R5
   \   000027   3400         ADDC    A,#0x0
   \   000029   FD           MOV     R5,A
   \   00002A   80D8         SJMP    ??Delay_I_1us_0
     39          }
   \                     ??Delay_I_1us_1:
   \   00002C   02....       LJMP    ?BRET
     40          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     41          void SPIWriteByte(uchar infor)
   \                     SPIWriteByte:
     42          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 0,R1
     43            unsigned int counter;
     44            for(counter=0;counter<8;counter++)
   \   000007   7E00         MOV     R6,#0x0
   \   000009   7F00         MOV     R7,#0x0
   \                     ??SPIWriteByte_0:
   \   00000B   C3           CLR     C
   \   00000C   EE           MOV     A,R6
   \   00000D   9408         SUBB    A,#0x8
   \   00000F   EF           MOV     A,R7
   \   000010   9400         SUBB    A,#0x0
   \   000012   5035         JNC     ??SPIWriteByte_1
     45            {
     46              
     47              if(infor&0x80)
   \   000014   E5..         MOV     A,?V0 + 0
   \   000016   A2E7         MOV     C,0xE0 /* A   */.7
   \   000018   5004         JNC     ??SPIWriteByte_2
     48                IC_MOSI = 1;
   \   00001A   D292         SETB    0x90.2
   \   00001C   8002         SJMP    ??SPIWriteByte_3
     49              else 
     50                IC_MOSI = 0;
   \                     ??SPIWriteByte_2:
   \   00001E   C292         CLR     0x90.2
     51              Delay_I_1us(3);
   \                     ??SPIWriteByte_3:
   \   000020                ; Setup parameters for call to function Delay_I_1us
   \   000020   7A03         MOV     R2,#0x3
   \   000022   7B00         MOV     R3,#0x0
   \   000024   12....       LCALL   ??Delay_I_1us?relay
     52              
     53              IC_SCK = 0;
   \   000027   C281         CLR     0x80.1
     54              Delay_I_1us(1);
   \   000029                ; Setup parameters for call to function Delay_I_1us
   \   000029   7A01         MOV     R2,#0x1
   \   00002B   7B00         MOV     R3,#0x0
   \   00002D   12....       LCALL   ??Delay_I_1us?relay
     55              
     56              
     57              IC_SCK = 1; 
   \   000030   D281         SETB    0x80.1
     58              Delay_I_1us(3);
   \   000032                ; Setup parameters for call to function Delay_I_1us
   \   000032   7A03         MOV     R2,#0x3
   \   000034   7B00         MOV     R3,#0x0
   \   000036   12....       LCALL   ??Delay_I_1us?relay
     59              
     60              
     61              infor <<= 1; 
   \   000039   E5..         MOV     A,?V0 + 0
   \   00003B   C3           CLR     C
   \   00003C   33           RLC     A
   \   00003D   F5..         MOV     ?V0 + 0,A
     62            } 
   \   00003F   EE           MOV     A,R6
   \   000040   2401         ADD     A,#0x1
   \   000042   FE           MOV     R6,A
   \   000043   EF           MOV     A,R7
   \   000044   3400         ADDC    A,#0x0
   \   000046   FF           MOV     R7,A
   \   000047   80C2         SJMP    ??SPIWriteByte_0
     63          }
   \                     ??SPIWriteByte_1:
   \   000049   7F01         MOV     R7,#0x1
   \   00004B   02....       LJMP    ?BANKED_LEAVE_XDATA
   \   00004E                REQUIRE _A_P1
   \   00004E                REQUIRE _A_P0
     64          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     65          unsigned char SPIReadByte(void)
   \                     SPIReadByte:
     66          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
     67            unsigned int counter;
     68            unsigned char SPI_Data;
     69            for(counter=0;counter<8;counter++)
   \   000005   7E00         MOV     R6,#0x0
   \   000007   7F00         MOV     R7,#0x0
   \                     ??SPIReadByte_0:
   \   000009   C3           CLR     C
   \   00000A   EE           MOV     A,R6
   \   00000B   9408         SUBB    A,#0x8
   \   00000D   EF           MOV     A,R7
   \   00000E   9400         SUBB    A,#0x0
   \   000010   5034         JNC     ??SPIReadByte_1
     70            {
     71              SPI_Data<<=1;
   \   000012   E5..         MOV     A,?V0 + 0
   \   000014   C3           CLR     C
   \   000015   33           RLC     A
   \   000016   F5..         MOV     ?V0 + 0,A
     72              
     73              IC_SCK = 0;
   \   000018   C281         CLR     0x80.1
     74              Delay_I_1us(3);  
   \   00001A                ; Setup parameters for call to function Delay_I_1us
   \   00001A   7A03         MOV     R2,#0x3
   \   00001C   7B00         MOV     R3,#0x0
   \   00001E   12....       LCALL   ??Delay_I_1us?relay
     75              
     76              
     77              if(IC_MISO == 1)
   \   000021   A284         MOV     C,0x80.4
   \   000023   5007         JNC     ??SPIReadByte_2
     78                SPI_Data |= 0x01;
   \   000025   D3           SETB    C
   \   000026   E5..         MOV     A,?V0 + 0
   \   000028   92E0         MOV     0xE0 /* A   */.0,C
   \   00002A   F5..         MOV     ?V0 + 0,A
     79              Delay_I_1us(2);
   \                     ??SPIReadByte_2:
   \   00002C                ; Setup parameters for call to function Delay_I_1us
   \   00002C   7A02         MOV     R2,#0x2
   \   00002E   7B00         MOV     R3,#0x0
   \   000030   12....       LCALL   ??Delay_I_1us?relay
     80              
     81              IC_SCK = 1;
   \   000033   D281         SETB    0x80.1
     82              Delay_I_1us(3);  
   \   000035                ; Setup parameters for call to function Delay_I_1us
   \   000035   7A03         MOV     R2,#0x3
   \   000037   7B00         MOV     R3,#0x0
   \   000039   12....       LCALL   ??Delay_I_1us?relay
     83              
     84            }
   \   00003C   EE           MOV     A,R6
   \   00003D   2401         ADD     A,#0x1
   \   00003F   FE           MOV     R6,A
   \   000040   EF           MOV     A,R7
   \   000041   3400         ADDC    A,#0x0
   \   000043   FF           MOV     R7,A
   \   000044   80C3         SJMP    ??SPIReadByte_0
     85            return SPI_Data;
   \                     ??SPIReadByte_1:
   \   000046   A9..         MOV     R1,?V0 + 0
   \   000048   7F01         MOV     R7,#0x1
   \   00004A   02....       LJMP    ?BANKED_LEAVE_XDATA
   \   00004D                REQUIRE _A_P0
     86          }
     87          
     88          /////////////////////////////////////////////////////////////////////
     89          //功    能：读RC632寄存器
     90          //参数说明：Address[IN]:寄存器地址
     91          //返    回：读出的值
     92          /////////////////////////////////////////////////////////////////////

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     93          unsigned char ReadRawRC(unsigned char Address)
   \                     ReadRawRC:
     94          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 0,R1
     95            unsigned char ucAddr;
     96            unsigned char ucResult=0;
   \   000007   7E00         MOV     R6,#0x0
     97            IC_CS = 0;
   \   000009   C297         CLR     0x90.7
     98            ucAddr = ((Address<<1)&0x7E)|0x80;//地址变换，SPI的读写地址有要求
   \   00000B   E5..         MOV     A,?V0 + 0
   \   00000D   C3           CLR     C
   \   00000E   33           RLC     A
   \   00000F   4480         ORL     A,#0x80
   \   000011   FF           MOV     R7,A
     99            SPIWriteByte(ucAddr);
   \   000012                ; Setup parameters for call to function SPIWriteByte
   \   000012   F9           MOV     R1,A
   \   000013   12....       LCALL   ??SPIWriteByte?relay
    100            ucResult=SPIReadByte();
   \   000016                ; Setup parameters for call to function SPIReadByte
   \   000016   12....       LCALL   ??SPIReadByte?relay
   \   000019   E9           MOV     A,R1
   \   00001A   FE           MOV     R6,A
    101            IC_CS = 1;
   \   00001B   D297         SETB    0x90.7
    102            return ucResult;
   \   00001D   F9           MOV     R1,A
   \   00001E   7F01         MOV     R7,#0x1
   \   000020   02....       LJMP    ?BANKED_LEAVE_XDATA
   \   000023                REQUIRE _A_P1
    103          }
    104          /////////////////////////////////////////////////////////////////////
    105          //功    能：写RC632寄存器
    106          //参数说明：Address[IN]:寄存器地址
    107          //          value[IN]:写入的值
    108          /////////////////////////////////////////////////////////////////////

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    109          void WriteRawRC(unsigned char Address, unsigned char value)
   \                     WriteRawRC:
    110          {  
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 0,R1
   \   000007   EA           MOV     A,R2
   \   000008   FF           MOV     R7,A
    111            unsigned char ucAddr;
    112            Address <<= 1;
   \   000009   E5..         MOV     A,?V0 + 0
   \   00000B   C3           CLR     C
   \   00000C   33           RLC     A
   \   00000D   F5..         MOV     ?V0 + 0,A
    113            ucAddr = (Address&0x7e);
   \   00000F   747E         MOV     A,#0x7e
   \   000011   55..         ANL     A,?V0 + 0
   \   000013   FE           MOV     R6,A
    114            IC_CS = 0;
   \   000014   C297         CLR     0x90.7
    115            
    116            SPIWriteByte(ucAddr);
   \   000016                ; Setup parameters for call to function SPIWriteByte
   \   000016   F9           MOV     R1,A
   \   000017   12....       LCALL   ??SPIWriteByte?relay
    117            SPIWriteByte(value);
   \   00001A                ; Setup parameters for call to function SPIWriteByte
   \   00001A   EF           MOV     A,R7
   \   00001B   F9           MOV     R1,A
   \   00001C   12....       LCALL   ??SPIWriteByte?relay
    118            IC_CS = 1;
   \   00001F   D297         SETB    0x90.7
    119          }
   \   000021   7F01         MOV     R7,#0x1
   \   000023   02....       LJMP    ?BANKED_LEAVE_XDATA
   \   000026                REQUIRE _A_P1
    120          
    121          /////////////////////////////////////////////////////////////////////
    122          //功    能：置RC522寄存器位
    123          //参数说明：reg[IN]:寄存器地址
    124          //          mask[IN]:置位值
    125          /////////////////////////////////////////////////////////////////////

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    126          void SetBitMask(unsigned char reg,unsigned char mask)  
   \                     SetBitMask:
    127          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   E9           MOV     A,R1
   \   000006   FE           MOV     R6,A
   \   000007   EA           MOV     A,R2
   \   000008   FF           MOV     R7,A
    128            char tmp = 0x0;
   \   000009   75..00       MOV     ?V0 + 0,#0x0
    129            tmp = ReadRawRC(reg);
   \   00000C                ; Setup parameters for call to function ReadRawRC
   \   00000C   EE           MOV     A,R6
   \   00000D   F9           MOV     R1,A
   \   00000E   12....       LCALL   ??ReadRawRC?relay
   \   000011   E9           MOV     A,R1
   \   000012   F5..         MOV     ?V0 + 0,A
    130            WriteRawRC(reg,tmp | mask);  // set bit mask
   \   000014                ; Setup parameters for call to function WriteRawRC
   \   000014   E5..         MOV     A,?V0 + 0
   \   000016   4F           ORL     A,R7
   \   000017   FA           MOV     R2,A
   \   000018   EE           MOV     A,R6
   \   000019   F9           MOV     R1,A
   \   00001A   12....       LCALL   ??WriteRawRC?relay
    131          }
   \   00001D   7F01         MOV     R7,#0x1
   \   00001F   02....       LJMP    ?BANKED_LEAVE_XDATA
    132          
    133          /////////////////////////////////////////////////////////////////////
    134          //功    能：清RC522寄存器位
    135          //参数说明：reg[IN]:寄存器地址
    136          //          mask[IN]:清位值
    137          /////////////////////////////////////////////////////////////////////

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    138          void ClearBitMask(unsigned char reg,unsigned char mask)  
   \                     ClearBitMask:
    139          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   E9           MOV     A,R1
   \   000006   FE           MOV     R6,A
   \   000007   EA           MOV     A,R2
   \   000008   FF           MOV     R7,A
    140            char tmp = 0x0;
   \   000009   75..00       MOV     ?V0 + 0,#0x0
    141            tmp = ReadRawRC(reg);
   \   00000C                ; Setup parameters for call to function ReadRawRC
   \   00000C   EE           MOV     A,R6
   \   00000D   F9           MOV     R1,A
   \   00000E   12....       LCALL   ??ReadRawRC?relay
   \   000011   E9           MOV     A,R1
   \   000012   F5..         MOV     ?V0 + 0,A
    142            WriteRawRC(reg, tmp & ~mask);  // clear bit mask
   \   000014                ; Setup parameters for call to function WriteRawRC
   \   000014   EF           MOV     A,R7
   \   000015   F4           CPL     A
   \   000016   55..         ANL     A,?V0 + 0
   \   000018   FA           MOV     R2,A
   \   000019   EE           MOV     A,R6
   \   00001A   F9           MOV     R1,A
   \   00001B   12....       LCALL   ??WriteRawRC?relay
    143          } 
   \   00001E   7F01         MOV     R7,#0x1
   \   000020   02....       LJMP    ?BANKED_LEAVE_XDATA
    144          
    145          
    146          
    147          
    148          /////////////////////////////////////////////////////////////////////
    149          //开启天线  
    150          //每次启动或关闭天险发射之间应至少有1ms的间隔
    151          /////////////////////////////////////////////////////////////////////

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    152          void PcdAntennaOn(void)
   \                     PcdAntennaOn:
    153          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
    154            unsigned char i;
    155            i = ReadRawRC(TxControlReg);
   \   000005                ; Setup parameters for call to function ReadRawRC
   \   000005   7914         MOV     R1,#0x14
   \   000007   12....       LCALL   ??ReadRawRC?relay
   \   00000A   E9           MOV     A,R1
   \   00000B   FE           MOV     R6,A
    156            if (!(i & 0x03))
   \   00000C   7403         MOV     A,#0x3
   \   00000E   5E           ANL     A,R6
   \   00000F   7007         JNZ     ??PcdAntennaOn_0
    157            {
    158              SetBitMask(TxControlReg, 0x03);
   \   000011                ; Setup parameters for call to function SetBitMask
   \   000011   7A03         MOV     R2,#0x3
   \   000013   7914         MOV     R1,#0x14
   \   000015   12....       LCALL   ??SetBitMask?relay
    159            }
    160          }
   \                     ??PcdAntennaOn_0:
   \   000018   7F01         MOV     R7,#0x1
   \   00001A   02....       LJMP    ?BANKED_LEAVE_XDATA
    161          
    162          /////////////////////////////////////////////////////////////////////
    163          //关闭天线
    164          /////////////////////////////////////////////////////////////////////

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    165          void PcdAntennaOff(void)
   \                     PcdAntennaOff:
    166          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    167            ClearBitMask(TxControlReg, 0x03);
   \   000004                ; Setup parameters for call to function ClearBitMask
   \   000004   7A03         MOV     R2,#0x3
   \   000006   7914         MOV     R1,#0x14
   \   000008   12....       LCALL   ??ClearBitMask?relay
    168          }
   \   00000B   D083         POP     DPH
   \   00000D   D082         POP     DPL
   \   00000F   02....       LJMP    ?BRET
    169          
    170          
    171          /////////////////////////////////////////////////////////////////////
    172          //功    能：复位RC522
    173          //返    回: 成功返回MI_OK
    174          /////////////////////////////////////////////////////////////////////

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    175          void PcdReset(void)
   \                     PcdReset:
    176          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    177            //PORTD|=(1<<RC522RST);
    178            IC_REST = 1;
   \   000004   D285         SETB    0x80.5
    179            Delay_I_1us(1);
   \   000006                ; Setup parameters for call to function Delay_I_1us
   \   000006   7A01         MOV     R2,#0x1
   \   000008   7B00         MOV     R3,#0x0
   \   00000A   12....       LCALL   ??Delay_I_1us?relay
    180            //PORTD&=~(1<<RC522RST);
    181            IC_REST = 0;
   \   00000D   C285         CLR     0x80.5
    182            Delay_I_1us(1);
   \   00000F                ; Setup parameters for call to function Delay_I_1us
   \   00000F   7A01         MOV     R2,#0x1
   \   000011   7B00         MOV     R3,#0x0
   \   000013   12....       LCALL   ??Delay_I_1us?relay
    183            //PORTD|=(1<<RC522RST);
    184            IC_REST = 1;
   \   000016   D285         SETB    0x80.5
    185            Delay_I_1us(1);
   \   000018                ; Setup parameters for call to function Delay_I_1us
   \   000018   7A01         MOV     R2,#0x1
   \   00001A   7B00         MOV     R3,#0x0
   \   00001C   12....       LCALL   ??Delay_I_1us?relay
    186            WriteRawRC(0x01,0x0f);
   \   00001F                ; Setup parameters for call to function WriteRawRC
   \   00001F   7A0F         MOV     R2,#0xf
   \   000021   7901         MOV     R1,#0x1
   \   000023   12....       LCALL   ??WriteRawRC?relay
    187            while(ReadRawRC(0x01)&0x10);   //检查卡片
   \                     ??PcdReset_0:
   \   000026                ; Setup parameters for call to function ReadRawRC
   \   000026   7901         MOV     R1,#0x1
   \   000028   12....       LCALL   ??ReadRawRC?relay
   \   00002B   E9           MOV     A,R1
   \   00002C   F8           MOV     R0,A
   \   00002D   A2E4         MOV     C,0xE0 /* A   */.4
   \   00002F   40F5         JC      ??PcdReset_0
    188            Delay_I_1us(10);
   \   000031                ; Setup parameters for call to function Delay_I_1us
   \   000031   7A0A         MOV     R2,#0xa
   \   000033   7B00         MOV     R3,#0x0
   \   000035   12....       LCALL   ??Delay_I_1us?relay
    189            
    190            WriteRawRC(ModeReg,0x3D);            //定义发送和接收常用模式 和Mifare卡通讯，CRC初始值0x6363
   \   000038                ; Setup parameters for call to function WriteRawRC
   \   000038   7A3D         MOV     R2,#0x3d
   \   00003A   7911         MOV     R1,#0x11
   \   00003C   12....       LCALL   ??WriteRawRC?relay
    191            WriteRawRC(TReloadRegL,30);           //16位定时器低位
   \   00003F                ; Setup parameters for call to function WriteRawRC
   \   00003F   7A1E         MOV     R2,#0x1e
   \   000041   792D         MOV     R1,#0x2d
   \   000043   12....       LCALL   ??WriteRawRC?relay
    192            WriteRawRC(TReloadRegH,0);			 //16位定时器高位
   \   000046                ; Setup parameters for call to function WriteRawRC
   \   000046   7A00         MOV     R2,#0x0
   \   000048   792C         MOV     R1,#0x2c
   \   00004A   12....       LCALL   ??WriteRawRC?relay
    193            WriteRawRC(TModeReg,0x8D);				//定义内部定时器的设置
   \   00004D                ; Setup parameters for call to function WriteRawRC
   \   00004D   7A8D         MOV     R2,#-0x73
   \   00004F   792A         MOV     R1,#0x2a
   \   000051   12....       LCALL   ??WriteRawRC?relay
    194            WriteRawRC(TPrescalerReg,0x3E);			//设置定时器分频系数
   \   000054                ; Setup parameters for call to function WriteRawRC
   \   000054   7A3E         MOV     R2,#0x3e
   \   000056   792B         MOV     R1,#0x2b
   \   000058   12....       LCALL   ??WriteRawRC?relay
    195            WriteRawRC(TxAutoReg,0x40);				//	调制发送信号为100%ASK
   \   00005B                ; Setup parameters for call to function WriteRawRC
   \   00005B   7A40         MOV     R2,#0x40
   \   00005D   7915         MOV     R1,#0x15
   \   00005F   12....       LCALL   ??WriteRawRC?relay
    196            
    197            
    198            //return MI_OK;
    199          }
   \   000062   D083         POP     DPH
   \   000064   D082         POP     DPL
   \   000066   02....       LJMP    ?BRET
   \   000069                REQUIRE _A_P0
    200          
    201          
    202          //////////////////////////////////////////////////////////////////////
    203          //设置RC632的工作方式 
    204          //////////////////////////////////////////////////////////////////////

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    205          void M500PcdConfigISOType(unsigned char type)
   \                     M500PcdConfigISOType:
    206          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   E9           MOV     A,R1
   \   000006   FE           MOV     R6,A
    207            if (type == 'A')                     //ISO14443_A
   \   000007   7441         MOV     A,#0x41
   \   000009   6E           XRL     A,R6
   \   00000A   7042         JNZ     ??M500PcdConfigISOType_0
    208            { 
    209              ClearBitMask(Status2Reg,0x08);
   \   00000C                ; Setup parameters for call to function ClearBitMask
   \   00000C   7A08         MOV     R2,#0x8
   \   00000E   7908         MOV     R1,#0x8
   \   000010   12....       LCALL   ??ClearBitMask?relay
    210              WriteRawRC(ModeReg,0x3D);//3F
   \   000013                ; Setup parameters for call to function WriteRawRC
   \   000013   7A3D         MOV     R2,#0x3d
   \   000015   7911         MOV     R1,#0x11
   \   000017   12....       LCALL   ??WriteRawRC?relay
    211              WriteRawRC(RxSelReg,0x86);//84
   \   00001A                ; Setup parameters for call to function WriteRawRC
   \   00001A   7A86         MOV     R2,#-0x7a
   \   00001C   7917         MOV     R1,#0x17
   \   00001E   12....       LCALL   ??WriteRawRC?relay
    212              WriteRawRC(RFCfgReg,0x7F);   //4F
   \   000021                ; Setup parameters for call to function WriteRawRC
   \   000021   7A7F         MOV     R2,#0x7f
   \   000023   7926         MOV     R1,#0x26
   \   000025   12....       LCALL   ??WriteRawRC?relay
    213              WriteRawRC(TReloadRegL,30);//tmoLength);// TReloadVal = 'h6a =tmoLength(dec) 
   \   000028                ; Setup parameters for call to function WriteRawRC
   \   000028   7A1E         MOV     R2,#0x1e
   \   00002A   792D         MOV     R1,#0x2d
   \   00002C   12....       LCALL   ??WriteRawRC?relay
    214              WriteRawRC(TReloadRegH,0);
   \   00002F                ; Setup parameters for call to function WriteRawRC
   \   00002F   7A00         MOV     R2,#0x0
   \   000031   792C         MOV     R1,#0x2c
   \   000033   12....       LCALL   ??WriteRawRC?relay
    215              WriteRawRC(TModeReg,0x8D);
   \   000036                ; Setup parameters for call to function WriteRawRC
   \   000036   7A8D         MOV     R2,#-0x73
   \   000038   792A         MOV     R1,#0x2a
   \   00003A   12....       LCALL   ??WriteRawRC?relay
    216              WriteRawRC(TPrescalerReg,0x3E);
   \   00003D                ; Setup parameters for call to function WriteRawRC
   \   00003D   7A3E         MOV     R2,#0x3e
   \   00003F   792B         MOV     R1,#0x2b
   \   000041   12....       LCALL   ??WriteRawRC?relay
    217              Delay_I_1us(2);
   \   000044                ; Setup parameters for call to function Delay_I_1us
   \   000044   7A02         MOV     R2,#0x2
   \   000046   7B00         MOV     R3,#0x0
   \   000048   12....       LCALL   ??Delay_I_1us?relay
    218              PcdAntennaOn();//开天线
   \   00004B                ; Setup parameters for call to function PcdAntennaOn
   \   00004B   12....       LCALL   ??PcdAntennaOn?relay
    219            }
    220            //  else return (-1); 
    221            
    222            //return MI_OK;
    223          }
   \                     ??M500PcdConfigISOType_0:
   \   00004E   7F01         MOV     R7,#0x1
   \   000050   02....       LJMP    ?BANKED_LEAVE_XDATA
    224          
    225          /////////////////////////////////////////////////////////////////////
    226          //功    能：通过RC522和ISO14443卡通讯
    227          //参数说明：Command[IN]:RC522命令字
    228          //          pInData[IN]:通过RC522发送到卡片的数据
    229          //          InLenByte[IN]:发送数据的字节长度
    230          //          pOutData[OUT]:接收到的卡片返回数据
    231          //          *pOutLenBit[OUT]:返回数据的位长度
    232          /////////////////////////////////////////////////////////////////////

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    233          char PcdComMF522(unsigned char Command, 		//RC522命令字
   \                     PcdComMF522:
    234                           unsigned char *pInData, 		//通过RC522发送到卡片的数据
    235                           unsigned char InLenByte,		//发送数据的字节长度
    236                           unsigned char *pOutData, 		//接收到的卡片返回数据
    237                           unsigned int  *pOutLenBit)		//返回数据的位长度
    238          {
   \   000000   74E8         MOV     A,#-0x18
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 24
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 0,R1
   \   000007   8A..         MOV     ?V0 + 14,R2
   \   000009   8B..         MOV     ?V0 + 15,R3
   \   00000B   8C..         MOV     ?V0 + 8,R4
   \   00000D   7418         MOV     A,#0x18
   \   00000F   12....       LCALL   ?XSTACK_DISP0_8
   \   000012   E0           MOVX    A,@DPTR
   \   000013   F5..         MOV     ?V0 + 12,A
   \   000015   A3           INC     DPTR
   \   000016   E0           MOVX    A,@DPTR
   \   000017   F5..         MOV     ?V0 + 13,A
   \   000019   741A         MOV     A,#0x1a
   \   00001B   12....       LCALL   ?XSTACK_DISP0_8
   \   00001E   E0           MOVX    A,@DPTR
   \   00001F   F5..         MOV     ?V0 + 10,A
   \   000021   A3           INC     DPTR
   \   000022   E0           MOVX    A,@DPTR
   \   000023   F5..         MOV     ?V0 + 11,A
    239            char status = MI_ERR;
   \   000025   75..BB       MOV     ?V0 + 1,#-0x45
    240            unsigned char irqEn   = 0x00;
   \   000028   75..00       MOV     ?V0 + 2,#0x0
    241            unsigned char waitFor = 0x00;
   \   00002B   75..00       MOV     ?V0 + 3,#0x0
    242            unsigned char lastBits;
    243            unsigned char n;
    244            unsigned int i;
    245            switch (Command)
   \   00002E   E5..         MOV     A,?V0 + 0
   \   000030   24F4         ADD     A,#-0xc
   \   000032   600C         JZ      ??PcdComMF522_0
   \   000034   24FE         ADD     A,#-0x2
   \   000036   700E         JNZ     ??PcdComMF522_1
    246            {
    247            case PCD_AUTHENT:		//Mifare认证
    248              irqEn   = 0x12;		//允许错误中断请求ErrIEn  允许空闲中断IdleIEn
   \   000038   75..12       MOV     ?V0 + 2,#0x12
    249              waitFor = 0x10;		//认证寻卡等待时候 查询空闲中断标志位
   \   00003B   75..10       MOV     ?V0 + 3,#0x10
    250              break;
   \   00003E   8006         SJMP    ??PcdComMF522_1
    251            case PCD_TRANSCEIVE:		//接收发送 发送接收
    252              irqEn   = 0x77;		//允许TxIEn RxIEn IdleIEn LoAlertIEn ErrIEn TimerIEn
   \                     ??PcdComMF522_0:
   \   000040   75..77       MOV     ?V0 + 2,#0x77
    253              waitFor = 0x30;		//寻卡等待时候 查询接收中断标志位与 空闲中断标志位
   \   000043   75..30       MOV     ?V0 + 3,#0x30
    254              break;
    255            default:
    256              break;
    257            }
    258            
    259            WriteRawRC(ComIEnReg,irqEn|0x80);		//IRqInv置位管脚IRQ与Status1Reg的IRq位的值相反 
   \                     ??PcdComMF522_1:
   \   000046                ; Setup parameters for call to function WriteRawRC
   \   000046   7480         MOV     A,#-0x80
   \   000048   45..         ORL     A,?V0 + 2
   \   00004A   FA           MOV     R2,A
   \   00004B   7902         MOV     R1,#0x2
   \   00004D   12....       LCALL   ??WriteRawRC?relay
    260            ClearBitMask(ComIrqReg,0x80);			//Set1该位清零时，CommIRqReg的屏蔽位清零
   \   000050                ; Setup parameters for call to function ClearBitMask
   \   000050   7A80         MOV     R2,#-0x80
   \   000052   7904         MOV     R1,#0x4
   \   000054   12....       LCALL   ??ClearBitMask?relay
    261            WriteRawRC(CommandReg,PCD_IDLE);		//写空闲命令
   \   000057                ; Setup parameters for call to function WriteRawRC
   \   000057   7A00         MOV     R2,#0x0
   \   000059   7901         MOV     R1,#0x1
   \   00005B   12....       LCALL   ??WriteRawRC?relay
    262            SetBitMask(FIFOLevelReg,0x80);			//置位FlushBuffer清除内部FIFO的读和写指针以及ErrReg的BufferOvfl标志位被清除
   \   00005E                ; Setup parameters for call to function SetBitMask
   \   00005E   7A80         MOV     R2,#-0x80
   \   000060   790A         MOV     R1,#0xa
   \   000062   12....       LCALL   ??SetBitMask?relay
    263            
    264            for (i=0; i<InLenByte; i++)
   \   000065   7E00         MOV     R6,#0x0
   \   000067   7F00         MOV     R7,#0x0
   \                     ??PcdComMF522_2:
   \   000069   85....       MOV     ?V0 + 6,?V0 + 8
   \   00006C   75..00       MOV     ?V0 + 7,#0x0
   \   00006F   C3           CLR     C
   \   000070   EE           MOV     A,R6
   \   000071   95..         SUBB    A,?V0 + 6
   \   000073   EF           MOV     A,R7
   \   000074   95..         SUBB    A,?V0 + 7
   \   000076   501B         JNC     ??PcdComMF522_3
    265            {   WriteRawRC(FIFODataReg, pInData[i]);    }		//写数据进FIFOdata
   \   000078                ; Setup parameters for call to function WriteRawRC
   \   000078   E5..         MOV     A,?V0 + 14
   \   00007A   2E           ADD     A,R6
   \   00007B   F582         MOV     DPL,A
   \   00007D   E5..         MOV     A,?V0 + 15
   \   00007F   3F           ADDC    A,R7
   \   000080   F583         MOV     DPH,A
   \   000082   E0           MOVX    A,@DPTR
   \   000083   FA           MOV     R2,A
   \   000084   7909         MOV     R1,#0x9
   \   000086   12....       LCALL   ??WriteRawRC?relay
   \   000089   EE           MOV     A,R6
   \   00008A   2401         ADD     A,#0x1
   \   00008C   FE           MOV     R6,A
   \   00008D   EF           MOV     A,R7
   \   00008E   3400         ADDC    A,#0x0
   \   000090   FF           MOV     R7,A
   \   000091   80D6         SJMP    ??PcdComMF522_2
    266            WriteRawRC(CommandReg, Command);					//写命令
   \                     ??PcdComMF522_3:
   \   000093                ; Setup parameters for call to function WriteRawRC
   \   000093   AA..         MOV     R2,?V0 + 0
   \   000095   7901         MOV     R1,#0x1
   \   000097   12....       LCALL   ??WriteRawRC?relay
    267            
    268            
    269            if (Command == PCD_TRANSCEIVE)
   \   00009A   740C         MOV     A,#0xc
   \   00009C   65..         XRL     A,?V0 + 0
   \   00009E   7007         JNZ     ??PcdComMF522_4
    270            {    SetBitMask(BitFramingReg,0x80);  }				//StartSend置位启动数据发送 该位与收发命令使用时才有效
   \   0000A0                ; Setup parameters for call to function SetBitMask
   \   0000A0   7A80         MOV     R2,#-0x80
   \   0000A2   790D         MOV     R1,#0xd
   \   0000A4   12....       LCALL   ??SetBitMask?relay
    271            
    272            i = 1000;//根据时钟频率调整，操作M1卡最大等待时间25ms
   \                     ??PcdComMF522_4:
   \   0000A7   7EE8         MOV     R6,#-0x18
   \   0000A9   7F03         MOV     R7,#0x3
    273            do 														//认证 与寻卡等待时间	
    274            {
    275              n = ReadRawRC(ComIrqReg);							//查询事件中断
   \                     ??PcdComMF522_5:
   \   0000AB                ; Setup parameters for call to function ReadRawRC
   \   0000AB   7904         MOV     R1,#0x4
   \   0000AD   12....       LCALL   ??ReadRawRC?relay
   \   0000B0   E9           MOV     A,R1
   \   0000B1   F5..         MOV     ?V0 + 4,A
    276              i--;
   \   0000B3   EE           MOV     A,R6
   \   0000B4   24FF         ADD     A,#-0x1
   \   0000B6   FE           MOV     R6,A
   \   0000B7   EF           MOV     A,R7
   \   0000B8   34FF         ADDC    A,#-0x1
   \   0000BA   FF           MOV     R7,A
    277            }
    278            while ((i!=0) && !(n&0x01) && !(n&waitFor));		//退出条件i=0,定时器中断，与写空闲命令
   \   0000BB   EE           MOV     A,R6
   \   0000BC   4F           ORL     A,R7
   \   0000BD   600C         JZ      ??PcdComMF522_6
   \   0000BF   E5..         MOV     A,?V0 + 4
   \   0000C1   A2E0         MOV     C,0xE0 /* A   */.0
   \   0000C3   4006         JC      ??PcdComMF522_6
   \   0000C5   E5..         MOV     A,?V0 + 4
   \   0000C7   55..         ANL     A,?V0 + 3
   \   0000C9   60E0         JZ      ??PcdComMF522_5
    279            ClearBitMask(BitFramingReg,0x80);					//清理允许StartSend位
   \                     ??PcdComMF522_6:
   \   0000CB                ; Setup parameters for call to function ClearBitMask
   \   0000CB   7A80         MOV     R2,#-0x80
   \   0000CD   790D         MOV     R1,#0xd
   \   0000CF   12....       LCALL   ??ClearBitMask?relay
    280            if (i!=0)
   \   0000D2   EE           MOV     A,R6
   \   0000D3   4F           ORL     A,R7
   \   0000D4   7003         JNZ     $+5
   \   0000D6   02....       LJMP    ??PcdComMF522_7 & 0xFFFF
    281            {    
    282              if(!(ReadRawRC(ErrorReg)&0x1B))			//读错误标志寄存器BufferOfI CollErr ParityErr ProtocolErr
   \   0000D9                ; Setup parameters for call to function ReadRawRC
   \   0000D9   7906         MOV     R1,#0x6
   \   0000DB   12....       LCALL   ??ReadRawRC?relay
   \   0000DE   E9           MOV     A,R1
   \   0000DF   541B         ANL     A,#0x1b
   \   0000E1   6003         JZ      $+5
   \   0000E3   02....       LJMP    ??PcdComMF522_8 & 0xFFFF
    283              {
    284                status = MI_OK;
   \   0000E6   75..26       MOV     ?V0 + 1,#0x26
    285                if (n & irqEn & 0x01)					//是否发生定时器中断
   \   0000E9   E5..         MOV     A,?V0 + 2
   \   0000EB   A2E0         MOV     C,0xE0 /* A   */.0
   \   0000ED   C0D0         PUSH    PSW
   \   0000EF   E5..         MOV     A,?V0 + 4
   \   0000F1   A2E0         MOV     C,0xE0 /* A   */.0
   \   0000F3   92F0         MOV     B.0,C
   \   0000F5   12....       LCALL   ?POP_BIT_ISP
   \   0000F8   1581         DEC     SP
   \   0000FA   82F0         ANL     C,B.0
   \   0000FC   5003         JNC     ??PcdComMF522_9
    286                {   status = MI_NOTAGERR;   }
   \   0000FE   75..CC       MOV     ?V0 + 1,#-0x34
    287                if (Command == PCD_TRANSCEIVE)
   \                     ??PcdComMF522_9:
   \   000101   740C         MOV     A,#0xc
   \   000103   65..         XRL     A,?V0 + 0
   \   000105   6003         JZ      $+5
   \   000107   02....       LJMP    ??PcdComMF522_7 & 0xFFFF
    288                {
    289                  n = ReadRawRC(FIFOLevelReg);			//读FIFO中保存的字节数
   \   00010A                ; Setup parameters for call to function ReadRawRC
   \   00010A   790A         MOV     R1,#0xa
   \   00010C   12....       LCALL   ??ReadRawRC?relay
   \   00010F   E9           MOV     A,R1
   \   000110   F5..         MOV     ?V0 + 4,A
    290                  lastBits = ReadRawRC(ControlReg) & 0x07;	//最后接收到得字节的有效位数
   \   000112                ; Setup parameters for call to function ReadRawRC
   \   000112   790C         MOV     R1,#0xc
   \   000114   12....       LCALL   ??ReadRawRC?relay
   \   000117   E9           MOV     A,R1
   \   000118   5407         ANL     A,#0x7
   \   00011A   F5..         MOV     ?V0 + 5,A
    291                  if (lastBits)
   \   00011C   E5..         MOV     A,?V0 + 5
   \   00011E   6040         JZ      ??PcdComMF522_10
    292                  {   *pOutLenBit = (n-1)*8 + lastBits;   }	//N个字节数减去1（最后一个字节）+最后一位的位数 读取到的数据总位数
   \   000120   85....       MOV     ?V0 + 6,?V0 + 4
   \   000123   75..00       MOV     ?V0 + 7,#0x0
   \   000126   E5..         MOV     A,?V0 + 6
   \   000128   24FF         ADD     A,#-0x1
   \   00012A   F8           MOV     R0,A
   \   00012B   E5..         MOV     A,?V0 + 7
   \   00012D   34FF         ADDC    A,#-0x1
   \   00012F   F9           MOV     R1,A
   \   000130   E8           MOV     A,R0
   \   000131   75F008       MOV     B,#0x8
   \   000134   A4           MUL     AB
   \   000135   C8           XCH     A,R0
   \   000136   AAF0         MOV     R2,B
   \   000138   75F000       MOV     B,#0x0
   \   00013B   A4           MUL     AB
   \   00013C   2A           ADD     A,R2
   \   00013D   FA           MOV     R2,A
   \   00013E   75F008       MOV     B,#0x8
   \   000141   E9           MOV     A,R1
   \   000142   A4           MUL     AB
   \   000143   2A           ADD     A,R2
   \   000144   F9           MOV     R1,A
   \   000145   85....       MOV     ?V0 + 6,?V0 + 5
   \   000148   75..00       MOV     ?V0 + 7,#0x0
   \   00014B   E8           MOV     A,R0
   \   00014C   25..         ADD     A,?V0 + 6
   \   00014E   F8           MOV     R0,A
   \   00014F   E9           MOV     A,R1
   \   000150   35..         ADDC    A,?V0 + 7
   \   000152   F9           MOV     R1,A
   \   000153   85..82       MOV     DPL,?V0 + 10
   \   000156   85..83       MOV     DPH,?V0 + 11
   \   000159   E8           MOV     A,R0
   \   00015A   F0           MOVX    @DPTR,A
   \   00015B   A3           INC     DPTR
   \   00015C   E9           MOV     A,R1
   \   00015D   F0           MOVX    @DPTR,A
   \   00015E   8026         SJMP    ??PcdComMF522_11
    293                  else
    294                  {   *pOutLenBit = n*8;   }					//最后接收到的字节整个字节有效
   \                     ??PcdComMF522_10:
   \   000160   E5..         MOV     A,?V0 + 4
   \   000162   A8..         MOV     R0,?V0 + 4
   \   000164   7900         MOV     R1,#0x0
   \   000166   E8           MOV     A,R0
   \   000167   75F008       MOV     B,#0x8
   \   00016A   A4           MUL     AB
   \   00016B   C8           XCH     A,R0
   \   00016C   AAF0         MOV     R2,B
   \   00016E   75F000       MOV     B,#0x0
   \   000171   A4           MUL     AB
   \   000172   2A           ADD     A,R2
   \   000173   FA           MOV     R2,A
   \   000174   75F008       MOV     B,#0x8
   \   000177   E9           MOV     A,R1
   \   000178   A4           MUL     AB
   \   000179   2A           ADD     A,R2
   \   00017A   F9           MOV     R1,A
   \   00017B   85..82       MOV     DPL,?V0 + 10
   \   00017E   85..83       MOV     DPH,?V0 + 11
   \   000181   E8           MOV     A,R0
   \   000182   F0           MOVX    @DPTR,A
   \   000183   A3           INC     DPTR
   \   000184   E9           MOV     A,R1
   \   000185   F0           MOVX    @DPTR,A
    295                  if (n == 0)									
   \                     ??PcdComMF522_11:
   \   000186   E5..         MOV     A,?V0 + 4
   \   000188   7003         JNZ     ??PcdComMF522_12
    296                  {   n = 1;    }
   \   00018A   75..01       MOV     ?V0 + 4,#0x1
    297                  if (n > MAXRLEN)
   \                     ??PcdComMF522_12:
   \   00018D   E5..         MOV     A,?V0 + 4
   \   00018F   C3           CLR     C
   \   000190   9413         SUBB    A,#0x13
   \   000192   4003         JC      ??PcdComMF522_13
    298                  {   n = MAXRLEN;   }
   \   000194   75..12       MOV     ?V0 + 4,#0x12
    299                  for (i=0; i<n; i++)
   \                     ??PcdComMF522_13:
   \   000197   7E00         MOV     R6,#0x0
   \   000199   7F00         MOV     R7,#0x0
   \                     ??PcdComMF522_14:
   \   00019B   85....       MOV     ?V0 + 6,?V0 + 4
   \   00019E   75..00       MOV     ?V0 + 7,#0x0
   \   0001A1   C3           CLR     C
   \   0001A2   EE           MOV     A,R6
   \   0001A3   95..         SUBB    A,?V0 + 6
   \   0001A5   EF           MOV     A,R7
   \   0001A6   95..         SUBB    A,?V0 + 7
   \   0001A8   5022         JNC     ??PcdComMF522_7
    300                  {   pOutData[i] = ReadRawRC(FIFODataReg);    }
   \   0001AA                ; Setup parameters for call to function ReadRawRC
   \   0001AA   7909         MOV     R1,#0x9
   \   0001AC   12....       LCALL   ??ReadRawRC?relay
   \   0001AF   E9           MOV     A,R1
   \   0001B0   C0E0         PUSH    A
   \   0001B2   E5..         MOV     A,?V0 + 12
   \   0001B4   2E           ADD     A,R6
   \   0001B5   F582         MOV     DPL,A
   \   0001B7   E5..         MOV     A,?V0 + 13
   \   0001B9   3F           ADDC    A,R7
   \   0001BA   F583         MOV     DPH,A
   \   0001BC   D0E0         POP     A
   \   0001BE   F0           MOVX    @DPTR,A
   \   0001BF   EE           MOV     A,R6
   \   0001C0   2401         ADD     A,#0x1
   \   0001C2   FE           MOV     R6,A
   \   0001C3   EF           MOV     A,R7
   \   0001C4   3400         ADDC    A,#0x0
   \   0001C6   FF           MOV     R7,A
   \   0001C7   80D2         SJMP    ??PcdComMF522_14
    301                }
    302              }
    303              else
    304              {   status = MI_ERR;   }
   \                     ??PcdComMF522_8:
   \   0001C9   75..BB       MOV     ?V0 + 1,#-0x45
    305            }
    306            
    307            SetBitMask(ControlReg,0x80);           // stop timer now
   \                     ??PcdComMF522_7:
   \   0001CC                ; Setup parameters for call to function SetBitMask
   \   0001CC   7A80         MOV     R2,#-0x80
   \   0001CE   790C         MOV     R1,#0xc
   \   0001D0   12....       LCALL   ??SetBitMask?relay
    308            WriteRawRC(CommandReg,PCD_IDLE); 
   \   0001D3                ; Setup parameters for call to function WriteRawRC
   \   0001D3   7A00         MOV     R2,#0x0
   \   0001D5   7901         MOV     R1,#0x1
   \   0001D7   12....       LCALL   ??WriteRawRC?relay
    309            return status;
   \   0001DA   A9..         MOV     R1,?V0 + 1
   \   0001DC   7F10         MOV     R7,#0x10
   \   0001DE   02....       LJMP    ?BANKED_LEAVE_XDATA
    310          }
    311          
    312          /////////////////////////////////////////////////////////////////////
    313          //功    能：寻卡
    314          //参数说明: req_code[IN]:寻卡方式
    315          //                0x52 = 寻感应区内所有符合14443A标准的卡
    316          //                0x26 = 寻未进入休眠状态的卡
    317          //          pTagType[OUT]：卡片类型代码
    318          //                0x4400 = Mifare_UltraLight
    319          //                0x0400 = Mifare_One(S50)
    320          //                0x0200 = Mifare_One(S70)
    321          //                0x0800 = Mifare_Pro(X)
    322          //                0x4403 = Mifare_DESFire
    323          //返    回: 成功返回MI_OK
    324          /////////////////////////////////////////////////////////////////////

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    325          char PcdRequest(unsigned char req_code,unsigned char *pTagType)
   \                     PcdRequest:
    326          {
   \   000000   74F4         MOV     A,#-0xc
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 20
   \   000005   74EC         MOV     A,#-0x14
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   89..         MOV     ?V0 + 3,R1
   \   00000C   EA           MOV     A,R2
   \   00000D   FE           MOV     R6,A
   \   00000E   EB           MOV     A,R3
   \   00000F   FF           MOV     R7,A
    327            char status;  
    328            // uint i;
    329            unsigned int  unLen;
    330            unsigned char ucComMF522Buf[MAXRLEN]; 
    331            
    332            ClearBitMask(Status2Reg,0x08);	//清理指示MIFARECyptol单元接通以及所有卡的数据通信被加密的情况
   \   000010                ; Setup parameters for call to function ClearBitMask
   \   000010   7A08         MOV     R2,#0x8
   \   000012   7908         MOV     R1,#0x8
   \   000014   12....       LCALL   ??ClearBitMask?relay
    333            WriteRawRC(BitFramingReg,0x07);	//	发送的最后一个字节的 七位
   \   000017                ; Setup parameters for call to function WriteRawRC
   \   000017   7A07         MOV     R2,#0x7
   \   000019   790D         MOV     R1,#0xd
   \   00001B   12....       LCALL   ??WriteRawRC?relay
    334            SetBitMask(TxControlReg,0x03);	//TX1,TX2管脚的输出信号传递经发送调制的13.56的能量载波信号
   \   00001E                ; Setup parameters for call to function SetBitMask
   \   00001E   7A03         MOV     R2,#0x3
   \   000020   7914         MOV     R1,#0x14
   \   000022   12....       LCALL   ??SetBitMask?relay
    335            
    336            ucComMF522Buf[0] = req_code;		//存入 卡片命令字
   \   000025   E5..         MOV     A,?V0 + 3
   \   000027   7402         MOV     A,#0x2
   \   000029   12....       LCALL   ?XSTACK_DISP0_8
   \   00002C   E5..         MOV     A,?V0 + 3
   \   00002E   F0           MOVX    @DPTR,A
    337            
    338            status = PcdComMF522(PCD_TRANSCEIVE,ucComMF522Buf,1,ucComMF522Buf,&unLen);	//寻卡    
   \   00002F                ; Setup parameters for call to function PcdComMF522
   \   00002F   85..82       MOV     DPL,?XSP + 0
   \   000032   85..83       MOV     DPH,?XSP + 1
   \   000035   8582..       MOV     ?V0 + 0,DPL
   \   000038   8583..       MOV     ?V0 + 1,DPH
   \   00003B   78..         MOV     R0,#?V0 + 0
   \   00003D   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000040   7404         MOV     A,#0x4
   \   000042   12....       LCALL   ?XSTACK_DISP0_8
   \   000045   8582..       MOV     ?V0 + 0,DPL
   \   000048   8583..       MOV     ?V0 + 1,DPH
   \   00004B   78..         MOV     R0,#?V0 + 0
   \   00004D   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000050   7C01         MOV     R4,#0x1
   \   000052   7406         MOV     A,#0x6
   \   000054   12....       LCALL   ?XSTACK_DISP0_8
   \   000057   AA82         MOV     R2,DPL
   \   000059   AB83         MOV     R3,DPH
   \   00005B   790C         MOV     R1,#0xc
   \   00005D   12....       LCALL   ??PcdComMF522?relay
   \   000060   7404         MOV     A,#0x4
   \   000062   12....       LCALL   ?DEALLOC_XSTACK8
   \   000065   E9           MOV     A,R1
   \   000066   F5..         MOV     ?V0 + 2,A
    339            if ((status == MI_OK) && (unLen == 0x10))	//寻卡成功返回卡类型 
   \   000068   7426         MOV     A,#0x26
   \   00006A   65..         XRL     A,?V0 + 2
   \   00006C   702A         JNZ     ??PcdRequest_0
   \   00006E   85..82       MOV     DPL,?XSP + 0
   \   000071   85..83       MOV     DPH,?XSP + 1
   \   000074   E0           MOVX    A,@DPTR
   \   000075   6410         XRL     A,#0x10
   \   000077   7004         JNZ     ??PcdRequest_1
   \   000079   A3           INC     DPTR
   \   00007A   E0           MOVX    A,@DPTR
   \   00007B   6400         XRL     A,#0x0
   \                     ??PcdRequest_1:
   \   00007D   7019         JNZ     ??PcdRequest_0
    340            {    
    341              *pTagType     = ucComMF522Buf[0];
   \   00007F   7402         MOV     A,#0x2
   \   000081   12....       LCALL   ?XSTACK_DISP0_8
   \   000084   E0           MOVX    A,@DPTR
   \   000085   8E82         MOV     DPL,R6
   \   000087   8F83         MOV     DPH,R7
   \   000089   F0           MOVX    @DPTR,A
    342              *(pTagType+1) = ucComMF522Buf[1];
   \   00008A   7403         MOV     A,#0x3
   \   00008C   12....       LCALL   ?XSTACK_DISP0_8
   \   00008F   E0           MOVX    A,@DPTR
   \   000090   8E82         MOV     DPL,R6
   \   000092   8F83         MOV     DPH,R7
   \   000094   A3           INC     DPTR
   \   000095   F0           MOVX    @DPTR,A
   \   000096   8003         SJMP    ??PcdRequest_2
    343            }
    344            else
    345            {   
    346              status = MI_ERR;
   \                     ??PcdRequest_0:
   \   000098   75..BB       MOV     ?V0 + 2,#-0x45
    347            }
    348            
    349            return status;
   \                     ??PcdRequest_2:
   \   00009B   A9..         MOV     R1,?V0 + 2
   \   00009D   7414         MOV     A,#0x14
   \   00009F   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000A2   7F04         MOV     R7,#0x4
   \   0000A4   02....       LJMP    ?BANKED_LEAVE_XDATA
    350          }
    351          
    352          /////////////////////////////////////////////////////////////////////
    353          //功    能：防冲撞
    354          //参数说明: pSnr[OUT]:卡片序列号，4字节
    355          //返    回: 成功返回MI_OK
    356          /////////////////////////////////////////////////////////////////////  

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    357          char PcdAnticoll(unsigned char *pSnr)
   \                     PcdAnticoll:
    358          {
   \   000000   74F3         MOV     A,#-0xd
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 13
   \   000005                ; Auto size: 20
   \   000005   74EC         MOV     A,#-0x14
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   EA           MOV     A,R2
   \   00000B   FE           MOV     R6,A
   \   00000C   EB           MOV     A,R3
   \   00000D   FF           MOV     R7,A
    359            char status;
    360            unsigned char i,snr_check=0;
   \   00000E   75..00       MOV     ?V0 + 3,#0x0
    361            unsigned int  unLen;
    362            unsigned char ucComMF522Buf[MAXRLEN]; 
    363            
    364            
    365            ClearBitMask(Status2Reg,0x08);		//清MFCryptol On位 只有成功执行MFAuthent命令后，该位才能置位
   \   000011                ; Setup parameters for call to function ClearBitMask
   \   000011   7A08         MOV     R2,#0x8
   \   000013   7908         MOV     R1,#0x8
   \   000015   12....       LCALL   ??ClearBitMask?relay
    366            WriteRawRC(BitFramingReg,0x00);		//清理寄存器 停止收发
   \   000018                ; Setup parameters for call to function WriteRawRC
   \   000018   7A00         MOV     R2,#0x0
   \   00001A   790D         MOV     R1,#0xd
   \   00001C   12....       LCALL   ??WriteRawRC?relay
    367            ClearBitMask(CollReg,0x80);			//清ValuesAfterColl所有接收的位在冲突后被清除
   \   00001F                ; Setup parameters for call to function ClearBitMask
   \   00001F   7A80         MOV     R2,#-0x80
   \   000021   790E         MOV     R1,#0xe
   \   000023   12....       LCALL   ??ClearBitMask?relay
    368            
    369            // WriteRawRC(BitFramingReg,0x07);	//	发送的最后一个字节的 七位
    370            // SetBitMask(TxControlReg,0x03);	//TX1,TX2管脚的输出信号传递经发送调制的13.56的能量载波信号
    371            
    372            ucComMF522Buf[0] = 0x93;	//卡片防冲突命令
   \   000026   7402         MOV     A,#0x2
   \   000028   12....       LCALL   ?XSTACK_DISP0_8
   \   00002B   7493         MOV     A,#-0x6d
   \   00002D   F0           MOVX    @DPTR,A
    373            ucComMF522Buf[1] = 0x20;
   \   00002E   7403         MOV     A,#0x3
   \   000030   12....       LCALL   ?XSTACK_DISP0_8
   \   000033   7420         MOV     A,#0x20
   \   000035   F0           MOVX    @DPTR,A
    374            
    375            status = PcdComMF522(PCD_TRANSCEIVE,ucComMF522Buf,2,ucComMF522Buf,&unLen);//与卡片通信
   \   000036                ; Setup parameters for call to function PcdComMF522
   \   000036   85..82       MOV     DPL,?XSP + 0
   \   000039   85..83       MOV     DPH,?XSP + 1
   \   00003C   8582..       MOV     ?V0 + 0,DPL
   \   00003F   8583..       MOV     ?V0 + 1,DPH
   \   000042   78..         MOV     R0,#?V0 + 0
   \   000044   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000047   7404         MOV     A,#0x4
   \   000049   12....       LCALL   ?XSTACK_DISP0_8
   \   00004C   8582..       MOV     ?V0 + 0,DPL
   \   00004F   8583..       MOV     ?V0 + 1,DPH
   \   000052   78..         MOV     R0,#?V0 + 0
   \   000054   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000057   7C02         MOV     R4,#0x2
   \   000059   7406         MOV     A,#0x6
   \   00005B   12....       LCALL   ?XSTACK_DISP0_8
   \   00005E   AA82         MOV     R2,DPL
   \   000060   AB83         MOV     R3,DPH
   \   000062   790C         MOV     R1,#0xc
   \   000064   12....       LCALL   ??PcdComMF522?relay
   \   000067   7404         MOV     A,#0x4
   \   000069   12....       LCALL   ?DEALLOC_XSTACK8
   \   00006C   E9           MOV     A,R1
   \   00006D   F5..         MOV     ?V0 + 2,A
    376            if (status == MI_OK)		//通信成功
   \   00006F   7426         MOV     A,#0x26
   \   000071   65..         XRL     A,?V0 + 2
   \   000073   7074         JNZ     ??PcdAnticoll_0
    377            {
    378              for (i=0; i<4; i++)
   \   000075   75..00       MOV     ?V0 + 4,#0x0
   \                     ??PcdAnticoll_1:
   \   000078   E5..         MOV     A,?V0 + 4
   \   00007A   C3           CLR     C
   \   00007B   9404         SUBB    A,#0x4
   \   00007D   504B         JNC     ??PcdAnticoll_2
    379              {   
    380                *(pSnr+i)  = ucComMF522Buf[i];			//读出UID
   \   00007F   85....       MOV     ?V0 + 0,?V0 + 4
   \   000082   75..00       MOV     ?V0 + 1,#0x0
   \   000085   7402         MOV     A,#0x2
   \   000087   12....       LCALL   ?XSTACK_DISP0_8
   \   00008A   E582         MOV     A,DPL
   \   00008C   25..         ADD     A,?V0 + 0
   \   00008E   F582         MOV     DPL,A
   \   000090   E583         MOV     A,DPH
   \   000092   35..         ADDC    A,?V0 + 1
   \   000094   F583         MOV     DPH,A
   \   000096   E0           MOVX    A,@DPTR
   \   000097   C0E0         PUSH    A
   \   000099   85....       MOV     ?V0 + 0,?V0 + 4
   \   00009C   75..00       MOV     ?V0 + 1,#0x0
   \   00009F   EE           MOV     A,R6
   \   0000A0   25..         ADD     A,?V0 + 0
   \   0000A2   F582         MOV     DPL,A
   \   0000A4   EF           MOV     A,R7
   \   0000A5   35..         ADDC    A,?V0 + 1
   \   0000A7   F583         MOV     DPH,A
   \   0000A9   D0E0         POP     A
   \   0000AB   F0           MOVX    @DPTR,A
    381                snr_check ^= ucComMF522Buf[i];
   \   0000AC   85....       MOV     ?V0 + 0,?V0 + 4
   \   0000AF   75..00       MOV     ?V0 + 1,#0x0
   \   0000B2   7402         MOV     A,#0x2
   \   0000B4   12....       LCALL   ?XSTACK_DISP0_8
   \   0000B7   E582         MOV     A,DPL
   \   0000B9   25..         ADD     A,?V0 + 0
   \   0000BB   F582         MOV     DPL,A
   \   0000BD   E583         MOV     A,DPH
   \   0000BF   35..         ADDC    A,?V0 + 1
   \   0000C1   F583         MOV     DPH,A
   \   0000C3   E0           MOVX    A,@DPTR
   \   0000C4   62..         XRL     ?V0 + 3,A
    382                
    383              }
   \   0000C6   05..         INC     ?V0 + 4
   \   0000C8   80AE         SJMP    ??PcdAnticoll_1
    384              if (snr_check != ucComMF522Buf[i])
   \                     ??PcdAnticoll_2:
   \   0000CA   85....       MOV     ?V0 + 0,?V0 + 4
   \   0000CD   75..00       MOV     ?V0 + 1,#0x0
   \   0000D0   7402         MOV     A,#0x2
   \   0000D2   12....       LCALL   ?XSTACK_DISP0_8
   \   0000D5   E582         MOV     A,DPL
   \   0000D7   25..         ADD     A,?V0 + 0
   \   0000D9   F582         MOV     DPL,A
   \   0000DB   E583         MOV     A,DPH
   \   0000DD   35..         ADDC    A,?V0 + 1
   \   0000DF   F583         MOV     DPH,A
   \   0000E1   E0           MOVX    A,@DPTR
   \   0000E2   65..         XRL     A,?V0 + 3
   \   0000E4   6003         JZ      ??PcdAnticoll_0
    385              {   status = MI_ERR;    }
   \   0000E6   75..BB       MOV     ?V0 + 2,#-0x45
    386            }
    387            
    388            SetBitMask(CollReg,0x80);
   \                     ??PcdAnticoll_0:
   \   0000E9                ; Setup parameters for call to function SetBitMask
   \   0000E9   7A80         MOV     R2,#-0x80
   \   0000EB   790E         MOV     R1,#0xe
   \   0000ED   12....       LCALL   ??SetBitMask?relay
    389            return status;
   \   0000F0   A9..         MOV     R1,?V0 + 2
   \   0000F2   7414         MOV     A,#0x14
   \   0000F4   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000F7   7F05         MOV     R7,#0x5
   \   0000F9   02....       LJMP    ?BANKED_LEAVE_XDATA
    390          }
    391          /////////////////////////////////////////////////////////////////////
    392          //用MF522计算CRC16函数
    393          /////////////////////////////////////////////////////////////////////

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    394          void CalulateCRC(unsigned char *pIndata,unsigned char len,unsigned char *pOutData)
   \                     CalulateCRC:
    395          {
   \   000000   74F1         MOV     A,#-0xf
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 15
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
   \   000006   FE           MOV     R6,A
   \   000007   EB           MOV     A,R3
   \   000008   FF           MOV     R7,A
   \   000009   89..         MOV     ?V0 + 5,R1
   \   00000B   8C..         MOV     ?V0 + 0,R4
   \   00000D   8D..         MOV     ?V0 + 1,R5
    396            unsigned char i,n;
    397            ClearBitMask(DivIrqReg,0x04);
   \   00000F                ; Setup parameters for call to function ClearBitMask
   \   00000F   7A04         MOV     R2,#0x4
   \   000011   7905         MOV     R1,#0x5
   \   000013   12....       LCALL   ??ClearBitMask?relay
    398            WriteRawRC(CommandReg,PCD_IDLE);
   \   000016                ; Setup parameters for call to function WriteRawRC
   \   000016   7A00         MOV     R2,#0x0
   \   000018   7901         MOV     R1,#0x1
   \   00001A   12....       LCALL   ??WriteRawRC?relay
    399            SetBitMask(FIFOLevelReg,0x80);
   \   00001D                ; Setup parameters for call to function SetBitMask
   \   00001D   7A80         MOV     R2,#-0x80
   \   00001F   790A         MOV     R1,#0xa
   \   000021   12....       LCALL   ??SetBitMask?relay
    400            for (i=0; i<len; i++)
   \   000024   75..00       MOV     ?V0 + 4,#0x0
   \                     ??CalulateCRC_0:
   \   000027   E5..         MOV     A,?V0 + 4
   \   000029   C3           CLR     C
   \   00002A   95..         SUBB    A,?V0 + 5
   \   00002C   501B         JNC     ??CalulateCRC_1
    401            {   WriteRawRC(FIFODataReg, *(pIndata+i));   }
   \   00002E                ; Setup parameters for call to function WriteRawRC
   \   00002E   85....       MOV     ?V0 + 2,?V0 + 4
   \   000031   75..00       MOV     ?V0 + 3,#0x0
   \   000034   EE           MOV     A,R6
   \   000035   25..         ADD     A,?V0 + 2
   \   000037   F582         MOV     DPL,A
   \   000039   EF           MOV     A,R7
   \   00003A   35..         ADDC    A,?V0 + 3
   \   00003C   F583         MOV     DPH,A
   \   00003E   E0           MOVX    A,@DPTR
   \   00003F   FA           MOV     R2,A
   \   000040   7909         MOV     R1,#0x9
   \   000042   12....       LCALL   ??WriteRawRC?relay
   \   000045   05..         INC     ?V0 + 4
   \   000047   80DE         SJMP    ??CalulateCRC_0
    402            WriteRawRC(CommandReg, PCD_CALCCRC);
   \                     ??CalulateCRC_1:
   \   000049                ; Setup parameters for call to function WriteRawRC
   \   000049   7A03         MOV     R2,#0x3
   \   00004B   7901         MOV     R1,#0x1
   \   00004D   12....       LCALL   ??WriteRawRC?relay
    403            i = 0xFF;
   \   000050   75..FF       MOV     ?V0 + 4,#-0x1
    404            do 
    405            {
    406              n = ReadRawRC(DivIrqReg);
   \                     ??CalulateCRC_2:
   \   000053                ; Setup parameters for call to function ReadRawRC
   \   000053   7905         MOV     R1,#0x5
   \   000055   12....       LCALL   ??ReadRawRC?relay
   \   000058   E9           MOV     A,R1
   \   000059   F5..         MOV     ?V0 + 6,A
    407              i--;
   \   00005B   15..         DEC     ?V0 + 4
    408            }
    409            while ((i!=0) && !(n&0x04));
   \   00005D   E5..         MOV     A,?V0 + 4
   \   00005F   6006         JZ      ??CalulateCRC_3
   \   000061   E5..         MOV     A,?V0 + 6
   \   000063   A2E2         MOV     C,0xE0 /* A   */.2
   \   000065   50EC         JNC     ??CalulateCRC_2
    410            pOutData[0] = ReadRawRC(CRCResultRegL);
   \                     ??CalulateCRC_3:
   \   000067                ; Setup parameters for call to function ReadRawRC
   \   000067   7922         MOV     R1,#0x22
   \   000069   12....       LCALL   ??ReadRawRC?relay
   \   00006C   E9           MOV     A,R1
   \   00006D   85..82       MOV     DPL,?V0 + 0
   \   000070   85..83       MOV     DPH,?V0 + 1
   \   000073   F0           MOVX    @DPTR,A
    411            pOutData[1] = ReadRawRC(CRCResultRegM);
   \   000074                ; Setup parameters for call to function ReadRawRC
   \   000074   7921         MOV     R1,#0x21
   \   000076   12....       LCALL   ??ReadRawRC?relay
   \   000079   E9           MOV     A,R1
   \   00007A   85..82       MOV     DPL,?V0 + 0
   \   00007D   85..83       MOV     DPH,?V0 + 1
   \   000080   A3           INC     DPTR
   \   000081   F0           MOVX    @DPTR,A
    412          }
   \   000082   7F07         MOV     R7,#0x7
   \   000084   02....       LJMP    ?BANKED_LEAVE_XDATA
    413          /////////////////////////////////////////////////////////////////////
    414          //功    能：选定卡片
    415          //参数说明: pSnr[IN]:卡片序列号，4字节
    416          //返    回: 成功返回MI_OK
    417          /////////////////////////////////////////////////////////////////////

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    418          char PcdSelect(unsigned char *pSnr)
   \                     PcdSelect:
    419          {
   \   000000   74F4         MOV     A,#-0xc
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 20
   \   000005   74EC         MOV     A,#-0x14
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   EA           MOV     A,R2
   \   00000B   FE           MOV     R6,A
   \   00000C   EB           MOV     A,R3
   \   00000D   FF           MOV     R7,A
    420            char status;
    421            unsigned char i;
    422            unsigned int  unLen;
    423            unsigned char ucComMF522Buf[MAXRLEN]; 
    424            
    425            ucComMF522Buf[0] = PICC_ANTICOLL1;
   \   00000E   7402         MOV     A,#0x2
   \   000010   12....       LCALL   ?XSTACK_DISP0_8
   \   000013   7493         MOV     A,#-0x6d
   \   000015   F0           MOVX    @DPTR,A
    426            ucComMF522Buf[1] = 0x70;
   \   000016   7403         MOV     A,#0x3
   \   000018   12....       LCALL   ?XSTACK_DISP0_8
   \   00001B   7470         MOV     A,#0x70
   \   00001D   F0           MOVX    @DPTR,A
    427            ucComMF522Buf[6] = 0;
   \   00001E   7408         MOV     A,#0x8
   \   000020   12....       LCALL   ?XSTACK_DISP0_8
   \   000023   7400         MOV     A,#0x0
   \   000025   F0           MOVX    @DPTR,A
    428            for (i=0; i<4; i++)
   \   000026   75..00       MOV     ?V0 + 3,#0x0
   \                     ??PcdSelect_0:
   \   000029   E5..         MOV     A,?V0 + 3
   \   00002B   C3           CLR     C
   \   00002C   9404         SUBB    A,#0x4
   \   00002E   504D         JNC     ??PcdSelect_1
    429            {
    430              ucComMF522Buf[i+2] = *(pSnr+i);
   \   000030   85....       MOV     ?V0 + 0,?V0 + 3
   \   000033   75..00       MOV     ?V0 + 1,#0x0
   \   000036   EE           MOV     A,R6
   \   000037   25..         ADD     A,?V0 + 0
   \   000039   F582         MOV     DPL,A
   \   00003B   EF           MOV     A,R7
   \   00003C   35..         ADDC    A,?V0 + 1
   \   00003E   F583         MOV     DPH,A
   \   000040   E0           MOVX    A,@DPTR
   \   000041   C0E0         PUSH    A
   \   000043   85....       MOV     ?V0 + 0,?V0 + 3
   \   000046   75..00       MOV     ?V0 + 1,#0x0
   \   000049   7402         MOV     A,#0x2
   \   00004B   12....       LCALL   ?XSTACK_DISP0_8
   \   00004E   E582         MOV     A,DPL
   \   000050   25..         ADD     A,?V0 + 0
   \   000052   F582         MOV     DPL,A
   \   000054   E583         MOV     A,DPH
   \   000056   35..         ADDC    A,?V0 + 1
   \   000058   F583         MOV     DPH,A
   \   00005A   A3           INC     DPTR
   \   00005B   A3           INC     DPTR
   \   00005C   D0E0         POP     A
   \   00005E   F0           MOVX    @DPTR,A
    431              ucComMF522Buf[6]  ^= *(pSnr+i);
   \   00005F   85....       MOV     ?V0 + 0,?V0 + 3
   \   000062   75..00       MOV     ?V0 + 1,#0x0
   \   000065   EE           MOV     A,R6
   \   000066   25..         ADD     A,?V0 + 0
   \   000068   F582         MOV     DPL,A
   \   00006A   EF           MOV     A,R7
   \   00006B   35..         ADDC    A,?V0 + 1
   \   00006D   F583         MOV     DPH,A
   \   00006F   E0           MOVX    A,@DPTR
   \   000070   F8           MOV     R0,A
   \   000071   7408         MOV     A,#0x8
   \   000073   12....       LCALL   ?XSTACK_DISP0_8
   \   000076   E0           MOVX    A,@DPTR
   \   000077   68           XRL     A,R0
   \   000078   F0           MOVX    @DPTR,A
    432            }
   \   000079   05..         INC     ?V0 + 3
   \   00007B   80AC         SJMP    ??PcdSelect_0
    433            CalulateCRC(ucComMF522Buf,7,&ucComMF522Buf[7]);
   \                     ??PcdSelect_1:
   \   00007D                ; Setup parameters for call to function CalulateCRC
   \   00007D   7409         MOV     A,#0x9
   \   00007F   12....       LCALL   ?XSTACK_DISP0_8
   \   000082   AC82         MOV     R4,DPL
   \   000084   AD83         MOV     R5,DPH
   \   000086   7907         MOV     R1,#0x7
   \   000088   7402         MOV     A,#0x2
   \   00008A   12....       LCALL   ?XSTACK_DISP0_8
   \   00008D   AA82         MOV     R2,DPL
   \   00008F   AB83         MOV     R3,DPH
   \   000091   12....       LCALL   ??CalulateCRC?relay
    434            
    435            ClearBitMask(Status2Reg,0x08);
   \   000094                ; Setup parameters for call to function ClearBitMask
   \   000094   7A08         MOV     R2,#0x8
   \   000096   7908         MOV     R1,#0x8
   \   000098   12....       LCALL   ??ClearBitMask?relay
    436            
    437            status = PcdComMF522(PCD_TRANSCEIVE,ucComMF522Buf,9,ucComMF522Buf,&unLen);
   \   00009B                ; Setup parameters for call to function PcdComMF522
   \   00009B   85..82       MOV     DPL,?XSP + 0
   \   00009E   85..83       MOV     DPH,?XSP + 1
   \   0000A1   8582..       MOV     ?V0 + 0,DPL
   \   0000A4   8583..       MOV     ?V0 + 1,DPH
   \   0000A7   78..         MOV     R0,#?V0 + 0
   \   0000A9   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000AC   7404         MOV     A,#0x4
   \   0000AE   12....       LCALL   ?XSTACK_DISP0_8
   \   0000B1   8582..       MOV     ?V0 + 0,DPL
   \   0000B4   8583..       MOV     ?V0 + 1,DPH
   \   0000B7   78..         MOV     R0,#?V0 + 0
   \   0000B9   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000BC   7C09         MOV     R4,#0x9
   \   0000BE   7406         MOV     A,#0x6
   \   0000C0   12....       LCALL   ?XSTACK_DISP0_8
   \   0000C3   AA82         MOV     R2,DPL
   \   0000C5   AB83         MOV     R3,DPH
   \   0000C7   790C         MOV     R1,#0xc
   \   0000C9   12....       LCALL   ??PcdComMF522?relay
   \   0000CC   7404         MOV     A,#0x4
   \   0000CE   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000D1   E9           MOV     A,R1
   \   0000D2   F5..         MOV     ?V0 + 2,A
    438            
    439            if ((status == MI_OK) && (unLen == 0x18))
   \   0000D4   7426         MOV     A,#0x26
   \   0000D6   65..         XRL     A,?V0 + 2
   \   0000D8   7016         JNZ     ??PcdSelect_2
   \   0000DA   85..82       MOV     DPL,?XSP + 0
   \   0000DD   85..83       MOV     DPH,?XSP + 1
   \   0000E0   E0           MOVX    A,@DPTR
   \   0000E1   6418         XRL     A,#0x18
   \   0000E3   7004         JNZ     ??PcdSelect_3
   \   0000E5   A3           INC     DPTR
   \   0000E6   E0           MOVX    A,@DPTR
   \   0000E7   6400         XRL     A,#0x0
   \                     ??PcdSelect_3:
   \   0000E9   7005         JNZ     ??PcdSelect_2
    440            {   status = MI_OK;  }
   \   0000EB   75..26       MOV     ?V0 + 2,#0x26
   \   0000EE   8003         SJMP    ??PcdSelect_4
    441            else
    442            {   status = MI_ERR;    }
   \                     ??PcdSelect_2:
   \   0000F0   75..BB       MOV     ?V0 + 2,#-0x45
    443            
    444            return status;
   \                     ??PcdSelect_4:
   \   0000F3   A9..         MOV     R1,?V0 + 2
   \   0000F5   7414         MOV     A,#0x14
   \   0000F7   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000FA   7F04         MOV     R7,#0x4
   \   0000FC   02....       LJMP    ?BANKED_LEAVE_XDATA
    445          }
    446          
    447          /////////////////////////////////////////////////////////////////////
    448          //功    能：验证卡片密码
    449          //参数说明: auth_mode[IN]: 密码验证模式
    450          //                 0x60 = 验证A密钥
    451          //                 0x61 = 验证B密钥 
    452          //          addr[IN]：块地址
    453          //          pKey[IN]：密码
    454          //          pSnr[IN]：卡片序列号，4字节
    455          //返    回: 成功返回MI_OK
    456          /////////////////////////////////////////////////////////////////////               

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    457          char PcdAuthState(unsigned char auth_mode,unsigned char addr,unsigned char *pKey,unsigned char *pSnr)
   \                     PcdAuthState:
    458          {
   \   000000   74F0         MOV     A,#-0x10
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 16
   \   000005                ; Auto size: 20
   \   000005   74EC         MOV     A,#-0x14
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   89..         MOV     ?V0 + 2,R1
   \   00000C   8A..         MOV     ?V0 + 3,R2
   \   00000E   EC           MOV     A,R4
   \   00000F   FE           MOV     R6,A
   \   000010   ED           MOV     A,R5
   \   000011   FF           MOV     R7,A
   \   000012   7424         MOV     A,#0x24
   \   000014   12....       LCALL   ?XSTACK_DISP0_8
   \   000017   E0           MOVX    A,@DPTR
   \   000018   F8           MOV     R0,A
   \   000019   A3           INC     DPTR
   \   00001A   E0           MOVX    A,@DPTR
   \   00001B   F9           MOV     R1,A
   \   00001C   88..         MOV     ?V0 + 0,R0
   \   00001E   89..         MOV     ?V0 + 1,R1
    459            char status;
    460            unsigned int  unLen;
    461            unsigned char i,ucComMF522Buf[MAXRLEN]; 
    462            
    463            ucComMF522Buf[0] = auth_mode;
   \   000020   E5..         MOV     A,?V0 + 2
   \   000022   7402         MOV     A,#0x2
   \   000024   12....       LCALL   ?XSTACK_DISP0_8
   \   000027   E5..         MOV     A,?V0 + 2
   \   000029   F0           MOVX    @DPTR,A
    464            ucComMF522Buf[1] = addr;
   \   00002A   E5..         MOV     A,?V0 + 3
   \   00002C   7403         MOV     A,#0x3
   \   00002E   12....       LCALL   ?XSTACK_DISP0_8
   \   000031   E5..         MOV     A,?V0 + 3
   \   000033   F0           MOVX    @DPTR,A
    465            for (i=0; i<6; i++)
   \   000034   75..00       MOV     ?V0 + 7,#0x0
   \                     ??PcdAuthState_0:
   \   000037   E5..         MOV     A,?V0 + 7
   \   000039   C3           CLR     C
   \   00003A   9406         SUBB    A,#0x6
   \   00003C   5033         JNC     ??PcdAuthState_1
    466            {    ucComMF522Buf[i+2] = *(pKey+i);   }
   \   00003E   85....       MOV     ?V0 + 4,?V0 + 7
   \   000041   75..00       MOV     ?V0 + 5,#0x0
   \   000044   EE           MOV     A,R6
   \   000045   25..         ADD     A,?V0 + 4
   \   000047   F582         MOV     DPL,A
   \   000049   EF           MOV     A,R7
   \   00004A   35..         ADDC    A,?V0 + 5
   \   00004C   F583         MOV     DPH,A
   \   00004E   E0           MOVX    A,@DPTR
   \   00004F   C0E0         PUSH    A
   \   000051   85....       MOV     ?V0 + 4,?V0 + 7
   \   000054   75..00       MOV     ?V0 + 5,#0x0
   \   000057   7402         MOV     A,#0x2
   \   000059   12....       LCALL   ?XSTACK_DISP0_8
   \   00005C   E582         MOV     A,DPL
   \   00005E   25..         ADD     A,?V0 + 4
   \   000060   F582         MOV     DPL,A
   \   000062   E583         MOV     A,DPH
   \   000064   35..         ADDC    A,?V0 + 5
   \   000066   F583         MOV     DPH,A
   \   000068   A3           INC     DPTR
   \   000069   A3           INC     DPTR
   \   00006A   D0E0         POP     A
   \   00006C   F0           MOVX    @DPTR,A
   \   00006D   05..         INC     ?V0 + 7
   \   00006F   80C6         SJMP    ??PcdAuthState_0
    467            for (i=0; i<6; i++)
   \                     ??PcdAuthState_1:
   \   000071   75..00       MOV     ?V0 + 7,#0x0
   \                     ??PcdAuthState_2:
   \   000074   E5..         MOV     A,?V0 + 7
   \   000076   C3           CLR     C
   \   000077   9406         SUBB    A,#0x6
   \   000079   503B         JNC     ??PcdAuthState_3
    468            {    ucComMF522Buf[i+8] = *(pSnr+i);   }
   \   00007B   85....       MOV     ?V0 + 4,?V0 + 7
   \   00007E   75..00       MOV     ?V0 + 5,#0x0
   \   000081   E5..         MOV     A,?V0 + 0
   \   000083   25..         ADD     A,?V0 + 4
   \   000085   F582         MOV     DPL,A
   \   000087   E5..         MOV     A,?V0 + 1
   \   000089   35..         ADDC    A,?V0 + 5
   \   00008B   F583         MOV     DPH,A
   \   00008D   E0           MOVX    A,@DPTR
   \   00008E   C0E0         PUSH    A
   \   000090   85....       MOV     ?V0 + 4,?V0 + 7
   \   000093   75..00       MOV     ?V0 + 5,#0x0
   \   000096   7402         MOV     A,#0x2
   \   000098   12....       LCALL   ?XSTACK_DISP0_8
   \   00009B   E582         MOV     A,DPL
   \   00009D   25..         ADD     A,?V0 + 4
   \   00009F   F582         MOV     DPL,A
   \   0000A1   E583         MOV     A,DPH
   \   0000A3   35..         ADDC    A,?V0 + 5
   \   0000A5   F583         MOV     DPH,A
   \   0000A7   A3           INC     DPTR
   \   0000A8   A3           INC     DPTR
   \   0000A9   A3           INC     DPTR
   \   0000AA   A3           INC     DPTR
   \   0000AB   A3           INC     DPTR
   \   0000AC   A3           INC     DPTR
   \   0000AD   A3           INC     DPTR
   \   0000AE   A3           INC     DPTR
   \   0000AF   D0E0         POP     A
   \   0000B1   F0           MOVX    @DPTR,A
   \   0000B2   05..         INC     ?V0 + 7
   \   0000B4   80BE         SJMP    ??PcdAuthState_2
    469            //   memcpy(&ucComMF522Buf[2], pKey, 6); 
    470            //   memcpy(&ucComMF522Buf[8], pSnr, 4); 
    471            
    472            status = PcdComMF522(PCD_AUTHENT,ucComMF522Buf,12,ucComMF522Buf,&unLen);
   \                     ??PcdAuthState_3:
   \   0000B6                ; Setup parameters for call to function PcdComMF522
   \   0000B6   85..82       MOV     DPL,?XSP + 0
   \   0000B9   85..83       MOV     DPH,?XSP + 1
   \   0000BC   8582..       MOV     ?V0 + 4,DPL
   \   0000BF   8583..       MOV     ?V0 + 5,DPH
   \   0000C2   78..         MOV     R0,#?V0 + 4
   \   0000C4   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000C7   7404         MOV     A,#0x4
   \   0000C9   12....       LCALL   ?XSTACK_DISP0_8
   \   0000CC   8582..       MOV     ?V0 + 4,DPL
   \   0000CF   8583..       MOV     ?V0 + 5,DPH
   \   0000D2   78..         MOV     R0,#?V0 + 4
   \   0000D4   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000D7   7C0C         MOV     R4,#0xc
   \   0000D9   7406         MOV     A,#0x6
   \   0000DB   12....       LCALL   ?XSTACK_DISP0_8
   \   0000DE   AA82         MOV     R2,DPL
   \   0000E0   AB83         MOV     R3,DPH
   \   0000E2   790E         MOV     R1,#0xe
   \   0000E4   12....       LCALL   ??PcdComMF522?relay
   \   0000E7   7404         MOV     A,#0x4
   \   0000E9   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000EC   E9           MOV     A,R1
   \   0000ED   F5..         MOV     ?V0 + 6,A
    473            if ((status != MI_OK) || (!(ReadRawRC(Status2Reg) & 0x08)))
   \   0000EF   7426         MOV     A,#0x26
   \   0000F1   65..         XRL     A,?V0 + 6
   \   0000F3   700B         JNZ     ??PcdAuthState_4
   \   0000F5                ; Setup parameters for call to function ReadRawRC
   \   0000F5   7908         MOV     R1,#0x8
   \   0000F7   12....       LCALL   ??ReadRawRC?relay
   \   0000FA   E9           MOV     A,R1
   \   0000FB   F8           MOV     R0,A
   \   0000FC   A2E3         MOV     C,0xE0 /* A   */.3
   \   0000FE   4003         JC      ??PcdAuthState_5
    474            {   status = MI_ERR;   }
   \                     ??PcdAuthState_4:
   \   000100   75..BB       MOV     ?V0 + 6,#-0x45
    475            
    476            return status;
   \                     ??PcdAuthState_5:
   \   000103   A9..         MOV     R1,?V0 + 6
   \   000105   7414         MOV     A,#0x14
   \   000107   12....       LCALL   ?DEALLOC_XSTACK8
   \   00010A   7F08         MOV     R7,#0x8
   \   00010C   02....       LJMP    ?BANKED_LEAVE_XDATA
    477          }
    478          
    479          /////////////////////////////////////////////////////////////////////
    480          //功    能：写数据到M1卡一块
    481          //参数说明: addr[IN]：块地址
    482          //          pData[IN]：写入的数据，16字节
    483          //返    回: 成功返回MI_OK
    484          /////////////////////////////////////////////////////////////////////                  

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    485          char PcdWrite(unsigned char addr,unsigned char *pData)
   \                     PcdWrite:
    486          {
   \   000000   74F2         MOV     A,#-0xe
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 14
   \   000005                ; Auto size: 20
   \   000005   74EC         MOV     A,#-0x14
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   89..         MOV     ?V0 + 0,R1
   \   00000C   8A..         MOV     ?V0 + 2,R2
   \   00000E   8B..         MOV     ?V0 + 3,R3
    487            char status;
    488            unsigned int  unLen;
    489            unsigned char i,ucComMF522Buf[MAXRLEN]; 
    490            
    491            ucComMF522Buf[0] = PICC_WRITE;
   \   000010   7402         MOV     A,#0x2
   \   000012   12....       LCALL   ?XSTACK_DISP0_8
   \   000015   74A0         MOV     A,#-0x60
   \   000017   F0           MOVX    @DPTR,A
    492            ucComMF522Buf[1] = addr;
   \   000018   E5..         MOV     A,?V0 + 0
   \   00001A   7403         MOV     A,#0x3
   \   00001C   12....       LCALL   ?XSTACK_DISP0_8
   \   00001F   E5..         MOV     A,?V0 + 0
   \   000021   F0           MOVX    @DPTR,A
    493            CalulateCRC(ucComMF522Buf,2,&ucComMF522Buf[2]);
   \   000022                ; Setup parameters for call to function CalulateCRC
   \   000022   7404         MOV     A,#0x4
   \   000024   12....       LCALL   ?XSTACK_DISP0_8
   \   000027   AC82         MOV     R4,DPL
   \   000029   AD83         MOV     R5,DPH
   \   00002B   7902         MOV     R1,#0x2
   \   00002D   7402         MOV     A,#0x2
   \   00002F   12....       LCALL   ?XSTACK_DISP0_8
   \   000032   AA82         MOV     R2,DPL
   \   000034   AB83         MOV     R3,DPH
   \   000036   12....       LCALL   ??CalulateCRC?relay
    494            
    495            status = PcdComMF522(PCD_TRANSCEIVE,ucComMF522Buf,4,ucComMF522Buf,&unLen);
   \   000039                ; Setup parameters for call to function PcdComMF522
   \   000039   85..82       MOV     DPL,?XSP + 0
   \   00003C   85..83       MOV     DPH,?XSP + 1
   \   00003F   8582..       MOV     ?V0 + 4,DPL
   \   000042   8583..       MOV     ?V0 + 5,DPH
   \   000045   78..         MOV     R0,#?V0 + 4
   \   000047   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00004A   7404         MOV     A,#0x4
   \   00004C   12....       LCALL   ?XSTACK_DISP0_8
   \   00004F   8582..       MOV     ?V0 + 4,DPL
   \   000052   8583..       MOV     ?V0 + 5,DPH
   \   000055   78..         MOV     R0,#?V0 + 4
   \   000057   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00005A   7C04         MOV     R4,#0x4
   \   00005C   7406         MOV     A,#0x6
   \   00005E   12....       LCALL   ?XSTACK_DISP0_8
   \   000061   AA82         MOV     R2,DPL
   \   000063   AB83         MOV     R3,DPH
   \   000065   790C         MOV     R1,#0xc
   \   000067   12....       LCALL   ??PcdComMF522?relay
   \   00006A   7404         MOV     A,#0x4
   \   00006C   12....       LCALL   ?DEALLOC_XSTACK8
   \   00006F   E9           MOV     A,R1
   \   000070   FE           MOV     R6,A
    496            
    497            if ((status != MI_OK) || (unLen != 4) || ((ucComMF522Buf[0] & 0x0F) != 0x0A))
   \   000071   7426         MOV     A,#0x26
   \   000073   6E           XRL     A,R6
   \   000074   701D         JNZ     ??PcdWrite_0
   \   000076   85..82       MOV     DPL,?XSP + 0
   \   000079   85..83       MOV     DPH,?XSP + 1
   \   00007C   E0           MOVX    A,@DPTR
   \   00007D   6404         XRL     A,#0x4
   \   00007F   7004         JNZ     ??PcdWrite_1
   \   000081   A3           INC     DPTR
   \   000082   E0           MOVX    A,@DPTR
   \   000083   6400         XRL     A,#0x0
   \                     ??PcdWrite_1:
   \   000085   700C         JNZ     ??PcdWrite_0
   \   000087   7402         MOV     A,#0x2
   \   000089   12....       LCALL   ?XSTACK_DISP0_8
   \   00008C   E0           MOVX    A,@DPTR
   \   00008D   540F         ANL     A,#0xf
   \   00008F   640A         XRL     A,#0xa
   \   000091   6002         JZ      ??PcdWrite_2
    498            {   status = MI_ERR;   }
   \                     ??PcdWrite_0:
   \   000093   7EBB         MOV     R6,#-0x45
    499            
    500            if (status == MI_OK)
   \                     ??PcdWrite_2:
   \   000095   7426         MOV     A,#0x26
   \   000097   6E           XRL     A,R6
   \   000098   6003         JZ      $+5
   \   00009A   02....       LJMP    ??PcdWrite_3 & 0xFFFF
    501            {
    502              //memcpy(ucComMF522Buf, pData, 16);
    503              for (i=0; i<16; i++)
   \   00009D   7F00         MOV     R7,#0x0
   \                     ??PcdWrite_4:
   \   00009F   EF           MOV     A,R7
   \   0000A0   C3           CLR     C
   \   0000A1   9410         SUBB    A,#0x10
   \   0000A3   5030         JNC     ??PcdWrite_5
    504              {    ucComMF522Buf[i] = *(pData+i);   }
   \   0000A5   8F..         MOV     ?V0 + 4,R7
   \   0000A7   75..00       MOV     ?V0 + 5,#0x0
   \   0000AA   E5..         MOV     A,?V0 + 2
   \   0000AC   25..         ADD     A,?V0 + 4
   \   0000AE   F582         MOV     DPL,A
   \   0000B0   E5..         MOV     A,?V0 + 3
   \   0000B2   35..         ADDC    A,?V0 + 5
   \   0000B4   F583         MOV     DPH,A
   \   0000B6   E0           MOVX    A,@DPTR
   \   0000B7   C0E0         PUSH    A
   \   0000B9   8F..         MOV     ?V0 + 4,R7
   \   0000BB   75..00       MOV     ?V0 + 5,#0x0
   \   0000BE   7402         MOV     A,#0x2
   \   0000C0   12....       LCALL   ?XSTACK_DISP0_8
   \   0000C3   E582         MOV     A,DPL
   \   0000C5   25..         ADD     A,?V0 + 4
   \   0000C7   F582         MOV     DPL,A
   \   0000C9   E583         MOV     A,DPH
   \   0000CB   35..         ADDC    A,?V0 + 5
   \   0000CD   F583         MOV     DPH,A
   \   0000CF   D0E0         POP     A
   \   0000D1   F0           MOVX    @DPTR,A
   \   0000D2   0F           INC     R7
   \   0000D3   80CA         SJMP    ??PcdWrite_4
    505              CalulateCRC(ucComMF522Buf,16,&ucComMF522Buf[16]);
   \                     ??PcdWrite_5:
   \   0000D5                ; Setup parameters for call to function CalulateCRC
   \   0000D5   7412         MOV     A,#0x12
   \   0000D7   12....       LCALL   ?XSTACK_DISP0_8
   \   0000DA   AC82         MOV     R4,DPL
   \   0000DC   AD83         MOV     R5,DPH
   \   0000DE   7910         MOV     R1,#0x10
   \   0000E0   7402         MOV     A,#0x2
   \   0000E2   12....       LCALL   ?XSTACK_DISP0_8
   \   0000E5   AA82         MOV     R2,DPL
   \   0000E7   AB83         MOV     R3,DPH
   \   0000E9   12....       LCALL   ??CalulateCRC?relay
    506              
    507              status = PcdComMF522(PCD_TRANSCEIVE,ucComMF522Buf,18,ucComMF522Buf,&unLen);
   \   0000EC                ; Setup parameters for call to function PcdComMF522
   \   0000EC   85..82       MOV     DPL,?XSP + 0
   \   0000EF   85..83       MOV     DPH,?XSP + 1
   \   0000F2   8582..       MOV     ?V0 + 4,DPL
   \   0000F5   8583..       MOV     ?V0 + 5,DPH
   \   0000F8   78..         MOV     R0,#?V0 + 4
   \   0000FA   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000FD   7404         MOV     A,#0x4
   \   0000FF   12....       LCALL   ?XSTACK_DISP0_8
   \   000102   8582..       MOV     ?V0 + 4,DPL
   \   000105   8583..       MOV     ?V0 + 5,DPH
   \   000108   78..         MOV     R0,#?V0 + 4
   \   00010A   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00010D   7C12         MOV     R4,#0x12
   \   00010F   7406         MOV     A,#0x6
   \   000111   12....       LCALL   ?XSTACK_DISP0_8
   \   000114   AA82         MOV     R2,DPL
   \   000116   AB83         MOV     R3,DPH
   \   000118   790C         MOV     R1,#0xc
   \   00011A   12....       LCALL   ??PcdComMF522?relay
   \   00011D   7404         MOV     A,#0x4
   \   00011F   12....       LCALL   ?DEALLOC_XSTACK8
   \   000122   E9           MOV     A,R1
   \   000123   FE           MOV     R6,A
    508              if ((status != MI_OK) || (unLen != 4) || ((ucComMF522Buf[0] & 0x0F) != 0x0A))
   \   000124   7426         MOV     A,#0x26
   \   000126   6E           XRL     A,R6
   \   000127   701D         JNZ     ??PcdWrite_6
   \   000129   85..82       MOV     DPL,?XSP + 0
   \   00012C   85..83       MOV     DPH,?XSP + 1
   \   00012F   E0           MOVX    A,@DPTR
   \   000130   6404         XRL     A,#0x4
   \   000132   7004         JNZ     ??PcdWrite_7
   \   000134   A3           INC     DPTR
   \   000135   E0           MOVX    A,@DPTR
   \   000136   6400         XRL     A,#0x0
   \                     ??PcdWrite_7:
   \   000138   700C         JNZ     ??PcdWrite_6
   \   00013A   7402         MOV     A,#0x2
   \   00013C   12....       LCALL   ?XSTACK_DISP0_8
   \   00013F   E0           MOVX    A,@DPTR
   \   000140   540F         ANL     A,#0xf
   \   000142   640A         XRL     A,#0xa
   \   000144   6002         JZ      ??PcdWrite_3
    509              {   status = MI_ERR;   }
   \                     ??PcdWrite_6:
   \   000146   7EBB         MOV     R6,#-0x45
    510            } 
    511            return status;
   \                     ??PcdWrite_3:
   \   000148   EE           MOV     A,R6
   \   000149   F9           MOV     R1,A
   \   00014A   7414         MOV     A,#0x14
   \   00014C   12....       LCALL   ?DEALLOC_XSTACK8
   \   00014F   7F06         MOV     R7,#0x6
   \   000151   02....       LJMP    ?BANKED_LEAVE_XDATA
    512          }
    513          /////////////////////////////////////////////////////////////////////
    514          //功    能：读取M1卡一块数据
    515          //参数说明: addr[IN]：块地址
    516          //          pData[OUT]：读出的数据，16字节
    517          //返    回: 成功返回MI_OK
    518          ///////////////////////////////////////////////////////////////////// 

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    519          char PcdRead(unsigned char addr,unsigned char *pData)
   \                     PcdRead:
    520          {
   \   000000   74F2         MOV     A,#-0xe
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 14
   \   000005                ; Auto size: 20
   \   000005   74EC         MOV     A,#-0x14
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   89..         MOV     ?V0 + 1,R1
   \   00000C   EA           MOV     A,R2
   \   00000D   FE           MOV     R6,A
   \   00000E   EB           MOV     A,R3
   \   00000F   FF           MOV     R7,A
    521            char status;
    522            unsigned int  unLen;
    523            unsigned char i,ucComMF522Buf[MAXRLEN]; 
    524            
    525            ucComMF522Buf[0] = PICC_READ;
   \   000010   7402         MOV     A,#0x2
   \   000012   12....       LCALL   ?XSTACK_DISP0_8
   \   000015   7430         MOV     A,#0x30
   \   000017   F0           MOVX    @DPTR,A
    526            ucComMF522Buf[1] = addr;
   \   000018   E5..         MOV     A,?V0 + 1
   \   00001A   7403         MOV     A,#0x3
   \   00001C   12....       LCALL   ?XSTACK_DISP0_8
   \   00001F   E5..         MOV     A,?V0 + 1
   \   000021   F0           MOVX    @DPTR,A
    527            CalulateCRC(ucComMF522Buf,2,&ucComMF522Buf[2]);
   \   000022                ; Setup parameters for call to function CalulateCRC
   \   000022   7404         MOV     A,#0x4
   \   000024   12....       LCALL   ?XSTACK_DISP0_8
   \   000027   AC82         MOV     R4,DPL
   \   000029   AD83         MOV     R5,DPH
   \   00002B   7902         MOV     R1,#0x2
   \   00002D   7402         MOV     A,#0x2
   \   00002F   12....       LCALL   ?XSTACK_DISP0_8
   \   000032   AA82         MOV     R2,DPL
   \   000034   AB83         MOV     R3,DPH
   \   000036   12....       LCALL   ??CalulateCRC?relay
    528            
    529            status = PcdComMF522(PCD_TRANSCEIVE,ucComMF522Buf,4,ucComMF522Buf,&unLen);
   \   000039                ; Setup parameters for call to function PcdComMF522
   \   000039   85..82       MOV     DPL,?XSP + 0
   \   00003C   85..83       MOV     DPH,?XSP + 1
   \   00003F   8582..       MOV     ?V0 + 4,DPL
   \   000042   8583..       MOV     ?V0 + 5,DPH
   \   000045   78..         MOV     R0,#?V0 + 4
   \   000047   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00004A   7404         MOV     A,#0x4
   \   00004C   12....       LCALL   ?XSTACK_DISP0_8
   \   00004F   8582..       MOV     ?V0 + 4,DPL
   \   000052   8583..       MOV     ?V0 + 5,DPH
   \   000055   78..         MOV     R0,#?V0 + 4
   \   000057   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00005A   7C04         MOV     R4,#0x4
   \   00005C   7406         MOV     A,#0x6
   \   00005E   12....       LCALL   ?XSTACK_DISP0_8
   \   000061   AA82         MOV     R2,DPL
   \   000063   AB83         MOV     R3,DPH
   \   000065   790C         MOV     R1,#0xc
   \   000067   12....       LCALL   ??PcdComMF522?relay
   \   00006A   7404         MOV     A,#0x4
   \   00006C   12....       LCALL   ?DEALLOC_XSTACK8
   \   00006F   E9           MOV     A,R1
   \   000070   F5..         MOV     ?V0 + 0,A
    530            if ((status == MI_OK) && (unLen == 0x90))
   \   000072   7426         MOV     A,#0x26
   \   000074   65..         XRL     A,?V0 + 0
   \   000076   704C         JNZ     ??PcdRead_0
   \   000078   85..82       MOV     DPL,?XSP + 0
   \   00007B   85..83       MOV     DPH,?XSP + 1
   \   00007E   E0           MOVX    A,@DPTR
   \   00007F   6490         XRL     A,#0x90
   \   000081   7004         JNZ     ??PcdRead_1
   \   000083   A3           INC     DPTR
   \   000084   E0           MOVX    A,@DPTR
   \   000085   6400         XRL     A,#0x0
   \                     ??PcdRead_1:
   \   000087   703B         JNZ     ??PcdRead_0
    531              //   {   memcpy(pData, ucComMF522Buf, 16);   }
    532            {
    533              for (i=0; i<16; i++)
   \   000089   75..00       MOV     ?V0 + 2,#0x0
   \                     ??PcdRead_2:
   \   00008C   E5..         MOV     A,?V0 + 2
   \   00008E   C3           CLR     C
   \   00008F   9410         SUBB    A,#0x10
   \   000091   5034         JNC     ??PcdRead_3
    534              {    *(pData+i) = ucComMF522Buf[i];   }
   \   000093   85....       MOV     ?V0 + 4,?V0 + 2
   \   000096   75..00       MOV     ?V0 + 5,#0x0
   \   000099   7402         MOV     A,#0x2
   \   00009B   12....       LCALL   ?XSTACK_DISP0_8
   \   00009E   E582         MOV     A,DPL
   \   0000A0   25..         ADD     A,?V0 + 4
   \   0000A2   F582         MOV     DPL,A
   \   0000A4   E583         MOV     A,DPH
   \   0000A6   35..         ADDC    A,?V0 + 5
   \   0000A8   F583         MOV     DPH,A
   \   0000AA   E0           MOVX    A,@DPTR
   \   0000AB   C0E0         PUSH    A
   \   0000AD   85....       MOV     ?V0 + 4,?V0 + 2
   \   0000B0   75..00       MOV     ?V0 + 5,#0x0
   \   0000B3   EE           MOV     A,R6
   \   0000B4   25..         ADD     A,?V0 + 4
   \   0000B6   F582         MOV     DPL,A
   \   0000B8   EF           MOV     A,R7
   \   0000B9   35..         ADDC    A,?V0 + 5
   \   0000BB   F583         MOV     DPH,A
   \   0000BD   D0E0         POP     A
   \   0000BF   F0           MOVX    @DPTR,A
   \   0000C0   05..         INC     ?V0 + 2
   \   0000C2   80C8         SJMP    ??PcdRead_2
    535            }
    536            else
    537            {   status = MI_ERR;   }
   \                     ??PcdRead_0:
   \   0000C4   75..BB       MOV     ?V0 + 0,#-0x45
    538            
    539            return status;
   \                     ??PcdRead_3:
   \   0000C7   A9..         MOV     R1,?V0 + 0
   \   0000C9   7414         MOV     A,#0x14
   \   0000CB   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000CE   7F06         MOV     R7,#0x6
   \   0000D0   02....       LJMP    ?BANKED_LEAVE_XDATA
    540          }
    541          
    542          /////////////////////////////////////////////////////////////////////
    543          //功    能：命令卡片进入休眠状态
    544          //返    回: 成功返回MI_OK
    545          /////////////////////////////////////////////////////////////////////

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    546          char PcdHalt(void)
   \                     PcdHalt:
    547          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 20
   \   000005   74EC         MOV     A,#-0x14
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
    548            //    char status;
    549            unsigned int  unLen;
    550            unsigned char ucComMF522Buf[MAXRLEN]; 
    551            
    552            ucComMF522Buf[0] = PICC_HALT;
   \   00000A   7402         MOV     A,#0x2
   \   00000C   12....       LCALL   ?XSTACK_DISP0_8
   \   00000F   7450         MOV     A,#0x50
   \   000011   F0           MOVX    @DPTR,A
    553            ucComMF522Buf[1] = 0;
   \   000012   7403         MOV     A,#0x3
   \   000014   12....       LCALL   ?XSTACK_DISP0_8
   \   000017   7400         MOV     A,#0x0
   \   000019   F0           MOVX    @DPTR,A
    554            CalulateCRC(ucComMF522Buf,2,&ucComMF522Buf[2]);
   \   00001A                ; Setup parameters for call to function CalulateCRC
   \   00001A   7404         MOV     A,#0x4
   \   00001C   12....       LCALL   ?XSTACK_DISP0_8
   \   00001F   AC82         MOV     R4,DPL
   \   000021   AD83         MOV     R5,DPH
   \   000023   7902         MOV     R1,#0x2
   \   000025   7402         MOV     A,#0x2
   \   000027   12....       LCALL   ?XSTACK_DISP0_8
   \   00002A   AA82         MOV     R2,DPL
   \   00002C   AB83         MOV     R3,DPH
   \   00002E   12....       LCALL   ??CalulateCRC?relay
    555            PcdComMF522(PCD_TRANSCEIVE,ucComMF522Buf,4,ucComMF522Buf,&unLen);
   \   000031                ; Setup parameters for call to function PcdComMF522
   \   000031   85..82       MOV     DPL,?XSP + 0
   \   000034   85..83       MOV     DPH,?XSP + 1
   \   000037   8582..       MOV     ?V0 + 0,DPL
   \   00003A   8583..       MOV     ?V0 + 1,DPH
   \   00003D   78..         MOV     R0,#?V0 + 0
   \   00003F   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000042   7404         MOV     A,#0x4
   \   000044   12....       LCALL   ?XSTACK_DISP0_8
   \   000047   8582..       MOV     ?V0 + 0,DPL
   \   00004A   8583..       MOV     ?V0 + 1,DPH
   \   00004D   78..         MOV     R0,#?V0 + 0
   \   00004F   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000052   7C04         MOV     R4,#0x4
   \   000054   7406         MOV     A,#0x6
   \   000056   12....       LCALL   ?XSTACK_DISP0_8
   \   000059   AA82         MOV     R2,DPL
   \   00005B   AB83         MOV     R3,DPH
   \   00005D   790C         MOV     R1,#0xc
   \   00005F   12....       LCALL   ??PcdComMF522?relay
   \   000062   7404         MOV     A,#0x4
   \   000064   12....       LCALL   ?DEALLOC_XSTACK8
   \   000067   E9           MOV     A,R1
    556            // status = PcdComMF522(PCD_TRANSCEIVE,ucComMF522Buf,4,ucComMF522Buf,&unLen);
    557            
    558            return MI_OK;
   \   000068   7926         MOV     R1,#0x26
   \   00006A   7414         MOV     A,#0x14
   \   00006C   12....       LCALL   ?DEALLOC_XSTACK8
   \   00006F   7F02         MOV     R7,#0x2
   \   000071   02....       LJMP    ?BANKED_LEAVE_XDATA
    559          }
    560          
    561          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    562          void IC_CMT(uchar *UID,uchar *KEY,uchar RW,char *Dat)
   \                     IC_CMT:
    563          {
   \   000000   74F2         MOV     A,#-0xe
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 14
   \   000005                ; Auto size: 32
   \   000005   74E0         MOV     A,#-0x20
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   8A..         MOV     ?V0 + 2,R2
   \   00000C   8B..         MOV     ?V0 + 3,R3
   \   00000E   8C..         MOV     ?V0 + 0,R4
   \   000010   8D..         MOV     ?V0 + 1,R5
   \   000012   89..         MOV     ?V0 + 4,R1
   \   000014   742E         MOV     A,#0x2e
   \   000016   12....       LCALL   ?XSTACK_DISP0_8
   \   000019   E0           MOVX    A,@DPTR
   \   00001A   FE           MOV     R6,A
   \   00001B   A3           INC     DPTR
   \   00001C   E0           MOVX    A,@DPTR
   \   00001D   FF           MOV     R7,A
    564            uchar status = 0xab;
   \   00001E   75..AB       MOV     ?V0 + 5,#-0x55
    565            uchar qq[16]=0;//IC卡的类型
                                ^
Warning[Pe520]: initialization with "{...}" expected for aggregate object
   \   000021   90....       MOV     DPTR,#`?<Constant {0}>`
   \   000024   C082         PUSH    DPL
   \   000026   C083         PUSH    DPH
   \   000028   7410         MOV     A,#0x10
   \   00002A   12....       LCALL   ?XSTACK_DISP0_8
   \   00002D   AC82         MOV     R4,DPL
   \   00002F   AD83         MOV     R5,DPH
   \   000031   D083         POP     DPH
   \   000033   D082         POP     DPL
   \   000035   7410         MOV     A,#0x10
   \   000037   12....       LCALL   ?MOVE_LONG8_XDATA_XDATA
    566            uchar IC_uid[16]=0;//IC卡的UID
                                    ^
Warning[Pe520]: initialization with "{...}" expected for aggregate object
   \   00003A   90....       MOV     DPTR,#`?<Constant {0}>_1`
   \   00003D   C082         PUSH    DPL
   \   00003F   C083         PUSH    DPH
   \   000041   85..82       MOV     DPL,?XSP + 0
   \   000044   85..83       MOV     DPH,?XSP + 1
   \   000047   AC82         MOV     R4,DPL
   \   000049   AD83         MOV     R5,DPH
   \   00004B   D083         POP     DPH
   \   00004D   D082         POP     DPL
   \   00004F   7410         MOV     A,#0x10
   \   000051   12....       LCALL   ?MOVE_LONG8_XDATA_XDATA
    567            
    568            UartSend(PcdRequest(0x52,qq));//寻卡
   \   000054                ; Setup parameters for call to function UartSend
   \   000054                ; Setup parameters for call to function PcdRequest
   \   000054   7410         MOV     A,#0x10
   \   000056   12....       LCALL   ?XSTACK_DISP0_8
   \   000059   AA82         MOV     R2,DPL
   \   00005B   AB83         MOV     R3,DPH
   \   00005D   7952         MOV     R1,#0x52
   \   00005F   12....       LCALL   ??PcdRequest?relay
   \   000062   12....       LCALL   ??UartSend?relay
    569            UartSend(PcdAnticoll(IC_uid));//防冲撞
   \   000065                ; Setup parameters for call to function UartSend
   \   000065                ; Setup parameters for call to function PcdAnticoll
   \   000065   85..82       MOV     DPL,?XSP + 0
   \   000068   85..83       MOV     DPH,?XSP + 1
   \   00006B   AA82         MOV     R2,DPL
   \   00006D   AB83         MOV     R3,DPH
   \   00006F   12....       LCALL   ??PcdAnticoll?relay
   \   000072   12....       LCALL   ??UartSend?relay
    570            
    571            UartSend(PcdSelect(UID));//选定卡
   \   000075                ; Setup parameters for call to function UartSend
   \   000075                ; Setup parameters for call to function PcdSelect
   \   000075   AA..         MOV     R2,?V0 + 2
   \   000077   AB..         MOV     R3,?V0 + 3
   \   000079   12....       LCALL   ??PcdSelect?relay
   \   00007C   12....       LCALL   ??UartSend?relay
    572            
    573            UartSend(PcdAuthState(0x60,0x10,KEY,UID));//校验
   \   00007F                ; Setup parameters for call to function UartSend
   \   00007F                ; Setup parameters for call to function PcdAuthState
   \   00007F   78..         MOV     R0,#?V0 + 2
   \   000081   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000084   AC..         MOV     R4,?V0 + 0
   \   000086   AD..         MOV     R5,?V0 + 1
   \   000088   7A10         MOV     R2,#0x10
   \   00008A   7960         MOV     R1,#0x60
   \   00008C   12....       LCALL   ??PcdAuthState?relay
   \   00008F   7402         MOV     A,#0x2
   \   000091   12....       LCALL   ?DEALLOC_XSTACK8
   \   000094   12....       LCALL   ??UartSend?relay
    574            if(RW)//读写选择，1是读，0是写
   \   000097   E5..         MOV     A,?V0 + 4
   \   000099   600E         JZ      ??IC_CMT_0
    575            {
    576              UartSend (PcdRead(0x10,Dat));
                                            ^
Warning[Pe167]: argument of type "char *" is incompatible with parameter of
          type "unsigned char *"
   \   00009B                ; Setup parameters for call to function UartSend
   \   00009B                ; Setup parameters for call to function PcdRead
   \   00009B   EE           MOV     A,R6
   \   00009C   FA           MOV     R2,A
   \   00009D   EF           MOV     A,R7
   \   00009E   FB           MOV     R3,A
   \   00009F   7910         MOV     R1,#0x10
   \   0000A1   12....       LCALL   ??PcdRead?relay
   \   0000A4   12....       LCALL   ??UartSend?relay
   \   0000A7   800C         SJMP    ??IC_CMT_1
    577            }
    578            else 
    579            {
    580              UartSend(PcdWrite(0x10,Dat));
                                            ^
Warning[Pe167]: argument of type "char *" is incompatible with parameter of
          type "unsigned char *"

    uchar status = 0xab;
          ^
"C:\Texas Instruments\ZStack-CC2530-2.5.1a\Projects\zstack\Samples\Diplomaproject\Source\IC_w_r.c",564  Warning[Pe177]: 
          variable "status" was declared but never referenced
   \                     ??IC_CMT_0:
   \   0000A9                ; Setup parameters for call to function UartSend
   \   0000A9                ; Setup parameters for call to function PcdWrite
   \   0000A9   EE           MOV     A,R6
   \   0000AA   FA           MOV     R2,A
   \   0000AB   EF           MOV     A,R7
   \   0000AC   FB           MOV     R3,A
   \   0000AD   7910         MOV     R1,#0x10
   \   0000AF   12....       LCALL   ??PcdWrite?relay
   \   0000B2   12....       LCALL   ??UartSend?relay
    581            } 
    582            UartSend(PcdHalt());
   \                     ??IC_CMT_1:
   \   0000B5                ; Setup parameters for call to function UartSend
   \   0000B5                ; Setup parameters for call to function PcdHalt
   \   0000B5   12....       LCALL   ??PcdHalt?relay
   \   0000B8   12....       LCALL   ??UartSend?relay
    583          }
   \   0000BB   7420         MOV     A,#0x20
   \   0000BD   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000C0   7F06         MOV     R7,#0x6
   \   0000C2   02....       LJMP    ?BANKED_LEAVE_XDATA

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??Delay_I_1us?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    Delay_I_1us

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??SPIWriteByte?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    SPIWriteByte

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??SPIReadByte?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    SPIReadByte

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??ReadRawRC?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    ReadRawRC

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??WriteRawRC?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    WriteRawRC

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??SetBitMask?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    SetBitMask

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??ClearBitMask?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    ClearBitMask

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??PcdAntennaOn?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    PcdAntennaOn

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??PcdAntennaOff?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    PcdAntennaOff

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??PcdReset?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    PcdReset

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??M500PcdConfigISOType?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    M500PcdConfigISOType

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??PcdComMF522?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    PcdComMF522

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??PcdRequest?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    PcdRequest

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??PcdAnticoll?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    PcdAnticoll

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??CalulateCRC?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    CalulateCRC

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??PcdSelect?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    PcdSelect

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??PcdAuthState?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    PcdAuthState

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??PcdWrite?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    PcdWrite

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??PcdRead?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    PcdRead

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??PcdHalt?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    PcdHalt

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??IC_CMT?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    IC_CMT

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant {0}>`:
   \   000000   00           DB 0
   \   000001   00000000     DB 0, 0, 0, 0, 0, 0, 0, 0
   \            00000000
   \   000009   00000000     DB 0, 0, 0, 0, 0, 0, 0
   \            000000  

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant {0}>_1`:
   \   000000   00           DB 0
   \   000001   00000000     DB 0, 0, 0, 0, 0, 0, 0, 0
   \            00000000
   \   000009   00000000     DB 0, 0, 0, 0, 0, 0, 0
   \            000000  

   Maximum stack usage in bytes:

     Function             ISTACK PSTACK XSTACK
     --------             ------ ------ ------
     CalulateCRC              1      0     49
       -> ClearBitMask        0      0     30
       -> WriteRawRC          0      0     30
       -> SetBitMask          0      0     30
       -> WriteRawRC          0      0     30
       -> WriteRawRC          0      0     30
       -> ReadRawRC           0      0     30
       -> ReadRawRC           0      0     30
       -> ReadRawRC           0      0     30
     ClearBitMask             0      0     42
       -> ReadRawRC           0      0     18
       -> WriteRawRC          0      0     18
     Delay_I_1us              0      0      9
     IC_CMT                   2      0     50
       -> PcdRequest          0      0     92
       -> UartSend            0      0     92
       -> PcdAnticoll         0      0     92
       -> UartSend            0      0     92
       -> PcdSelect           0      0     92
       -> UartSend            0      0     92
       -> PcdAuthState        0      0     96
       -> UartSend            0      0     92
       -> PcdRead             0      0     92
       -> UartSend            0      0     92
       -> PcdWrite            0      0     92
       -> UartSend            0      0     92
       -> PcdHalt             0      0     92
       -> UartSend            0      0     92
     M500PcdConfigISOType     0      0      9
       -> ClearBitMask        0      0     18
       -> WriteRawRC          0      0     18
       -> WriteRawRC          0      0     18
       -> WriteRawRC          0      0     18
       -> WriteRawRC          0      0     18
       -> WriteRawRC          0      0     18
       -> WriteRawRC          0      0     18
       -> WriteRawRC          0      0     18
       -> Delay_I_1us         0      0     18
       -> PcdAntennaOn        0      0     18
     PcdAntennaOff            2      0      0
       -> ClearBitMask        4      0      0
     PcdAntennaOn             0      0     18
       -> ReadRawRC           0      0     18
       -> SetBitMask          0      0     18
     PcdAnticoll              1      0     83
       -> ClearBitMask        0      0     66
       -> WriteRawRC          0      0     66
       -> ClearBitMask        0      0     66
       -> PcdComMF522         0      0     74
       -> SetBitMask          0      0     66
     PcdAuthState             1      0     88
       -> PcdComMF522         0      0     80
       -> ReadRawRC           0      0     72
     PcdComMF522              1      0     64
       -> WriteRawRC          0      0     48
       -> ClearBitMask        0      0     48
       -> WriteRawRC          0      0     48
       -> SetBitMask          0      0     48
       -> WriteRawRC          0      0     48
       -> WriteRawRC          0      0     48
       -> SetBitMask          0      0     48
       -> ReadRawRC           0      0     48
       -> ClearBitMask        0      0     48
       -> ReadRawRC           0      0     48
       -> ReadRawRC           0      0     48
       -> ReadRawRC           0      0     48
       -> ReadRawRC           0      0     48
       -> SetBitMask          0      0     48
       -> WriteRawRC          0      0     48
     PcdHalt                  0      0     80
       -> CalulateCRC         0      0     60
       -> PcdComMF522         0      0     68
     PcdRead                  1      0     84
       -> CalulateCRC         0      0     68
       -> PcdComMF522         0      0     76
     PcdRequest               1      0     82
       -> ClearBitMask        0      0     64
       -> WriteRawRC          0      0     64
       -> SetBitMask          0      0     64
       -> PcdComMF522         0      0     72
     PcdReset                 2      0      0
       -> Delay_I_1us         4      0      0
       -> Delay_I_1us         4      0      0
       -> Delay_I_1us         4      0      0
       -> WriteRawRC          4      0      0
       -> ReadRawRC           4      0      0
       -> Delay_I_1us         4      0      0
       -> WriteRawRC          4      0      0
       -> WriteRawRC          4      0      0
       -> WriteRawRC          4      0      0
       -> WriteRawRC          4      0      0
       -> WriteRawRC          4      0      0
       -> WriteRawRC          4      0      0
     PcdSelect                1      0     82
       -> CalulateCRC         0      0     64
       -> ClearBitMask        0      0     64
       -> PcdComMF522         0      0     72
     PcdWrite                 1      0     84
       -> CalulateCRC         0      0     68
       -> PcdComMF522         0      0     76
       -> CalulateCRC         0      0     68
       -> PcdComMF522         0      0     76
     ReadRawRC                0      0     45
       -> SPIWriteByte        0      0     18
       -> SPIReadByte         0      0     18
     SPIReadByte              0      0     18
       -> Delay_I_1us         0      0     18
       -> Delay_I_1us         0      0     18
       -> Delay_I_1us         0      0     18
     SPIWriteByte             0      0     18
       -> Delay_I_1us         0      0     18
       -> Delay_I_1us         0      0     18
       -> Delay_I_1us         0      0     18
     SetBitMask               0      0     42
       -> ReadRawRC           0      0     18
       -> WriteRawRC          0      0     18
     WriteRawRC               0      0     42
       -> SPIWriteByte        0      0     18
       -> SPIWriteByte        0      0     18


   Segment part sizes:

     Function/Label               Bytes
     --------------               -----
     _A_P0                           1
     _A_P1                           1
     Delay_I_1us                    47
     SPIWriteByte                   78
     SPIReadByte                    77
     ReadRawRC                      35
     WriteRawRC                     38
     SetBitMask                     34
     ClearBitMask                   35
     PcdAntennaOn                   29
     PcdAntennaOff                  18
     PcdReset                      105
     M500PcdConfigISOType           83
     PcdComMF522                   481
     PcdRequest                    167
     PcdAnticoll                   252
     CalulateCRC                   135
     PcdSelect                     255
     PcdAuthState                  271
     PcdWrite                      340
     PcdRead                       211
     PcdHalt                       116
     IC_CMT                        197
     ??Delay_I_1us?relay             6
     ??SPIWriteByte?relay            6
     ??SPIReadByte?relay             6
     ??ReadRawRC?relay               6
     ??WriteRawRC?relay              6
     ??SetBitMask?relay              6
     ??ClearBitMask?relay            6
     ??PcdAntennaOn?relay            6
     ??PcdAntennaOff?relay           6
     ??PcdReset?relay                6
     ??M500PcdConfigISOType?relay    6
     ??PcdComMF522?relay             6
     ??PcdRequest?relay              6
     ??PcdAnticoll?relay             6
     ??CalulateCRC?relay             6
     ??PcdSelect?relay               6
     ??PcdAuthState?relay            6
     ??PcdWrite?relay                6
     ??PcdRead?relay                 6
     ??PcdHalt?relay                 6
     ??IC_CMT?relay                  6
     ?<Constant {0}>                16
     ?<Constant {0}>_1              16

 
 3 004 bytes in segment BANKED_CODE
   126 bytes in segment BANK_RELAYS
     2 bytes in segment SFR_AN
    32 bytes in segment XDATA_ROM_C
 
 3 130 bytes of CODE  memory
    32 bytes of CONST memory
     0 bytes of DATA  memory (+ 2 bytes shared)

Errors: none
Warnings: 5
